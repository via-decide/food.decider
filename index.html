<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    ```

Wait, `webgazer.js` might block loading if the user is offline and it's not cached. I'll keep the `async` tag and the `try-catch` in initialization to ensure the app works even if that script fails.

Okay, generating the final response.

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>| food.decide | v14.4</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="background-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <script src="https://webgazer.cs.brown.edu/webgazer.js" async></script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js').catch(e => console.log('SW Fail:', e));
        });
      }
    </script>

    <style>
        /* CORE STYLES */
        :root { --orange: #ff671f; --bg: #0a0a0a; --text: #f0f0f0; --go: #00e676; --red: #ff3333; --blue: #4285F4; --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        html, body { margin:0; padding:0; height:100%; width:100%; background:var(--bg); color:var(--text); font-family:var(--font); overflow:hidden; touch-action:none; }
        #master-container { height: 100vh; width: 100vw; position: relative; overflow: hidden; }

        /* SENSOR STATUS PILLS */
        .status-pill { position: fixed; left: 50%; transform: translateX(-50%); font-size: 0.6rem; color: #444; border: 1px solid #333; padding: 4px 8px; border-radius: 4px; opacity: 0; transition: opacity 0.5s; z-index: 1000; pointer-events: none; background: #000; }
        #gyro-status { top: 15px; } #eye-status { top: 40px; }
        .active-pill { opacity: 1 !important; color: var(--go) !important; border-color: var(--go) !important; }
        
        #gaze-dot { position: fixed; width: 10px; height: 10px; background: var(--orange); border-radius: 50%; z-index: 9999; pointer-events: none; display: none; transform: translate(-50%, -50%); box-shadow: 0 0 10px var(--orange); }

        /* SLIDES */
        .main-slide { height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; background: var(--bg); transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); will-change: transform; }
        .main-slide.prev { transform: translateY(-100%); } .main-slide.active { transform: translateY(0); z-index: 10; } .main-slide.next { transform: translateY(100%); z-index: 20; }

        .slide-header { padding: 20px; border-left: 3px solid var(--orange); height: 70px; flex-shrink: 0; z-index: 10; display: flex; align-items: center; }
        .header-title { font-size: 0.75rem; color: var(--orange); letter-spacing: 1px; font-weight: 700; text-transform: uppercase; }
        
        .carousel-viewport { position: relative; flex-grow: 1; width: 100%; height: 100%; perspective: 1000px; }
        
        /* CARD STYLES */
        .sub-slide { 
            position: absolute; inset: 0; padding: 25px; display: flex; flex-direction: column; justify-content: center; 
            opacity: 0; pointer-events: none; background: var(--bg); border-radius: 12px; 
            transform-origin: 50% 150%; 
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s; 
            will-change: transform; 
            overflow: hidden; /* Important for overlays */
        }
        .sub-slide.opt-active { z-index: 30; opacity: 1; pointer-events: auto; transform: translateX(0); }
        .sub-slide.opt-hidden { z-index: 0; opacity: 0; pointer-events: none; transform: scale(0.9); }
        .sub-slide.static { z-index: 30; opacity: 1; pointer-events: auto; transform: none; }

        /* GYRO TEXT OVERLAYS (The "Come to Life" Feature) */
        .overlay-label {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; font-weight: 900; letter-spacing: 2px; text-transform: uppercase;
            opacity: 0; pointer-events: none; z-index: 50; 
            transition: opacity 0.05s linear; /* Instant feedback */
        }
        .overlay-skip { background: rgba(255, 51, 51, 0.15); color: var(--red); transform: rotate(-10deg); }
        .overlay-browse { background: rgba(66, 133, 244, 0.15); color: var(--blue); transform: rotate(10deg); }
        .overlay-select { background: rgba(0, 230, 118, 0.15); color: var(--go); flex-direction: column; justify-content: flex-end; padding-bottom: 100px; }

        h1 { font-size: 1.8rem; margin: 0 0 15px 0; line-height: 1; letter-spacing: -1px; color: var(--orange); position: relative; z-index: 10; }
        .primary-question { font-size: 1.1rem; color: #fff; margin-bottom: 25px; font-weight: 600; position: relative; z-index: 10; }
        .price { font-size: 0.9rem; color: #aaa; margin-left: 10px; background: #222; padding: 2px 6px; border-radius: 4px; }
        .role-label { font-size: 0.6rem; color: #000; background: var(--go); padding: 4px 8px; border-radius: 4px; width: fit-content; margin-bottom: 15px; font-weight: bold; position: relative; z-index: 10; }
        .nav-hint { margin-top: 30px; padding-top: 20px; border-top: 1px solid #333; font-size: 0.7rem; color: #666; display: flex; justify-content: space-between; position: relative; z-index: 10; }

        /* UI */
        .lobby-container { display: flex; flex-direction: column; gap: 15px; padding: 30px; height: 100%; justify-content: center; }
        .cuisine-btn { background: #222; border: 1px solid #444; color: #888; padding: 20px; font-size: 1.2rem; font-weight: bold; border-radius: 12px; transition: all 0.2s; }
        .cuisine-btn.selected { background: var(--orange); color: #000; border-color: var(--orange); box-shadow: 0 0 15px rgba(255, 103, 31, 0.4); }
        .hunt-btn { background: #fff; color: #000; font-weight: 900; margin-top: 30px; letter-spacing: 2px; padding: 15px; border-radius: 8px; border: none; cursor: pointer;}
        
        /* UPDATED VISIBILITY FOR TOGGLES */
        .toggle-btn {
            background: transparent; 
            border: 1px solid #666; 
            color: #ccc; 
            font-size: 0.8rem; 
            font-weight: bold;
            flex: 1; 
            padding: 15px; 
            border-radius: 8px; 
            transition: all 0.3s;
            cursor: pointer;
        }
        .toggle-btn.active { 
            border-color: var(--go); 
            color: var(--go); 
            background: rgba(0, 230, 118, 0.1); 
            box-shadow: 0 0 15px rgba(0, 230, 118, 0.2); 
        }

        .final-actions { display: grid; gap: 10px; margin-top: 20px; }
        .btn { background: #222; color: #fff; border: 1px solid #333; padding: 15px; border-radius: 8px; font-weight: 600; text-align: center; font-size: 0.9rem; cursor: pointer; width: 100%; box-sizing: border-box;}
        .btn-zomato { background: #cb202d; opacity: 0.5; border:none;} .btn-swiggy { background: #fc8019; opacity: 0.5; border:none;} .btn-blinkit { background: #f8cb46; color: #000; opacity: 0.5; border:none;}
        .btn-wa { background: #25D366; color: #000; border: none; } .btn-cloud { background: #4285F4; border: none; }
        .btn-zomato.active, .btn-swiggy.active, .btn-blinkit.active { opacity: 1; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .input-group { border: 1px solid #333; background: #111; padding: 20px; border-radius: 8px; margin-bottom: 20px; min-height: 100px; max-height: 40vh; overflow-y: auto; }
        .input-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #333; padding: 10px 0; font-size: 0.8rem; }
        
        #mic-toggle { position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; background: #111; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #444; z-index: 2000; cursor: pointer; transition: all 0.3s; }
        #mic-toggle svg { width: 24px; height: 24px; fill: #666; }
        #mic-toggle.listening { border-color: var(--go); box-shadow: 0 0 15px rgba(0,230,118,0.3); }
        #mic-toggle.listening svg { fill: var(--go); }
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #222; color: #00e676; padding: 10px 20px; border: 1px solid #00e676; border-radius: 20px; font-size: 0.8rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 3000; white-space: nowrap; }
        #toast.visible { opacity: 1; }
    </style>
</head>
<body>

<div id="gyro-status" class="status-pill">GYRO ACTIVE</div>
<div id="eye-status" class="status-pill">EYE TRACKING ACTIVE</div>
<div id="gaze-dot"></div>
<div id="master-container"></div>
<div id="toast"></div>
<div id="mic-toggle" onclick="toggleListenMode()"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></div>

<script>
    // --- 1. CONFIG & DATA ---
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyBMwKxq92U0dptKMdEHvUCXPS9AjExHtxHjcRmfh2JFjCSn9Zd82bzp34xLg6X0a7L9g/exec";
    let SENSORS_ENABLED = false;
    let GAZE_ENABLED = false;
    let RAW_DATA = {}; 

    // YOUR DATA (Hardcoded for stability)
    const FALLBACK_MENU = {
      "version": "custom-v1",
      "data": {
        "punjabi": {
          "label": "PUNJABI",
          "categories": [
            { "id": "p_breads", "label": "Breads", "items": [ { "name": "Butter Naan", "price": 40 }, { "name": "Garlic Naan", "price": 50 }, { "name": "Tandoori Roti", "price": 25 }, { "name": "Lachha Paratha", "price": 55 } ] },
            { "id": "p_mains", "label": "Mains", "items": [ { "name": "Dal Makhani", "price": 220 }, { "name": "Paneer Butter Masala", "price": 240 }, { "name": "Shahi Paneer", "price": 250 }, { "name": "Butter Chicken", "price": 280 }, { "name": "Kadai Paneer", "price": 230 } ] },
            { "id": "p_rice", "label": "Rice", "items": [ { "name": "Jeera Rice", "price": 150 }, { "name": "Veg Pulao", "price": 160 }, { "name": "Chicken Biryani", "price": 290 } ] },
            { "id": "p_beverages", "label": "Beverages", "items": [ { "name": "Sweet Lassi", "price": 60 }, { "name": "Salted Lassi", "price": 50 }, { "name": "Masala Chaas", "price": 40 } ] }
          ]
        },
        "chinese": {
          "label": "CHINESE",
          "categories": [
            { "id": "c_dimsum", "label": "Dim Sum", "items": [ { "name": "Veg Crystal Dumpling", "price": 220 }, { "name": "Pork Siu Mai", "price": 260 }, { "name": "Har Gao", "price": 280 } ] },
            { "id": "c_noodles", "label": "Noodles", "items": [ { "name": "Lo Mein", "price": 220 }, { "name": "Dan Dan Noodles", "price": 260 }, { "name": "Hakka Noodles", "price": 200 } ] },
            { "id": "c_wok", "label": "Wok Specials", "items": [ { "name": "Kung Pao Chicken", "price": 280 }, { "name": "Mapo Tofu", "price": 240 }, { "name": "Chilli Chicken", "price": 260 } ] }
          ]
        },
        "pizza": {
          "label": "PIZZA",
          "categories": [
            { "id": "z_classic", "label": "Classic", "items": [ { "name": "Margherita", "price": 350 }, { "name": "Marinara", "price": 330 }, { "name": "Pepperoni", "price": 450 } ] },
            { "id": "z_gourmet", "label": "Gourmet", "items": [ { "name": "Burrata Pizza", "price": 550 }, { "name": "Truffle Mushroom Pizza", "price": 520 }, { "name": "Wood Fired Chicken Pizza", "price": 480 } ] }
          ]
        },
        "snacks": {
          "label": "NASTA PANI",
          "categories": [
            { "id": "s_packaged", "label": "Packaged", "items": [ { "name": "Coke", "price": 40 }, { "name": "Thums Up", "price": 40 }, { "name": "Chips", "price": 20 }, { "name": "Kurkure", "price": 20 } ] },
            { "id": "s_hot", "label": "Hot Snacks", "items": [ { "name": "Samosa", "price": 20 }, { "name": "Veg Puff", "price": 30 }, { "name": "Burger", "price": 60 } ] }
          ]
        }
      }
    };
    
    // LOAD DATA IMMEDIATELY
    RAW_DATA = FALLBACK_MENU.data; 
    let ENGINE_STATE = { session_id: "auto-" + Date.now(), cuisines_detected: [], items_detected: {}, platform_strategy: { fulfillment: [] } };

    // --- 2. INPUT ENGINES ---
    class GazeController {
        constructor() { this.active = false; this.lastTrigger = 0; }
        start() {
            if(this.active || typeof webgazer === 'undefined') return;
            this.active = true;
            document.getElementById('eye-status').classList.add('active-pill');
            document.getElementById('gaze-dot').style.display = 'block';
            webgazer.setGazeListener((data, elapsed) => {
                if (data == null) return;
                const dot = document.getElementById('gaze-dot');
                dot.style.left = data.x + 'px'; dot.style.top = data.y + 'px';
                if (Date.now() - this.lastTrigger > 1500) {
                    if (data.y < window.innerHeight * 0.2) this.trigger("UP");
                    else if (data.x < window.innerWidth * 0.2) this.trigger("LEFT");
                    else if (data.x > window.innerWidth * 0.8) this.trigger("RIGHT");
                }
            }).begin();
        }
        trigger(dir) {
            this.lastTrigger = Date.now();
            showToast("EYE: " + dir);
            if(dir === "UP") executeAction("SELECT");
            if(dir === "LEFT") executeAction("SKIP");
            if(dir === "RIGHT") executeAction("BROWSE");
        }
    }
    const gazeEngine = new GazeController();

    class PhysicsController {
        constructor(el, cbs) {
            this.el = el; this.cbs = cbs; this.active = false; this.current = {x:0, y:0}; this.target = {x:0, y:0};
            // GRAB OVERLAYS
            this.oSkip = el.querySelector('.overlay-skip');
            this.oBrowse = el.querySelector('.overlay-browse');
            this.oSelect = el.querySelector('.overlay-select');

            const s = e => this.start(e); const m = e => this.move(e); const e2 = () => this.end();
            el.addEventListener("mousedown",s); window.addEventListener("mousemove",m); window.addEventListener("mouseup",e2);
            el.addEventListener("touchstart",s,{passive:false}); el.addEventListener("touchmove",e=>{if(this.active)e.preventDefault();m(e)},{passive:false}); el.addEventListener("touchend",e2);
            if(SENSORS_ENABLED) {
                this.handleOrient = this.handleOrient.bind(this);
                if(window.DeviceOrientationEvent) window.addEventListener("deviceorientation", this.handleOrient);
                this.loop();
            }
        }
        cleanup() { window.removeEventListener("deviceorientation", this.handleOrient); }
        loop() {
            if(!SENSORS_ENABLED) return;
            this.current.x += (this.target.x - this.current.x) * 0.08;
            this.current.y += (this.target.y - this.current.y) * 0.08;
            this.updateVisuals(this.current.x, this.current.y);
            if(Math.abs(this.current.x) > 200) this.commit(Math.sign(this.current.x)*100, 0);
            else if(Math.abs(this.current.y) > 200) this.commit(0, Math.sign(this.current.y)*100);
            else requestAnimationFrame(() => this.loop());
        }
        handleOrient(e) {
            if(this.active) return;
            let g = e.gamma; let b = e.beta - 45;
            if(Math.abs(g) > 1) this.target.x = 1000 * Math.tan(g * Math.PI / 180); else this.target.x = 0;
            if(Math.abs(b) > 1) this.target.y = 1000 * Math.tan(b * Math.PI / 180); else this.target.y = 0;
        }
        start(e) { this.active=true; this.startPos={x:(e.touches?e.touches[0]:e).clientX, y:(e.touches?e.touches[0]:e).clientY}; this.el.style.transition="none"; }
        move(e) { 
            if(!this.active) return; 
            const c = (e.touches?e.touches[0]:e); 
            this.updateVisuals(c.clientX - this.startPos.x, c.clientY - this.startPos.y); 
        }
        updateVisuals(dx, dy) {
            this.el.style.transform = `translate(${dx}px, ${dy}px) rotate(${dx/20}deg)`;
            // TEXT COME TO LIFE LOGIC
            const opX = Math.min(Math.abs(dx)/150, 1);
            const opY = Math.min(Math.abs(dy)/150, 1);
            if(this.oSkip) this.oSkip.style.opacity = (dx < -20) ? opX : 0;
            if(this.oBrowse) this.oBrowse.style.opacity = (dx > 20) ? opX : 0;
            if(this.oSelect) this.oSelect.style.opacity = (dy < -20) ? opY : 0;
        }
        end() { 
            if(!this.active) return; this.active=false;
            const m = new WebKitCSSMatrix(getComputedStyle(this.el).transform);
            if(Math.hypot(m.m41, m.m42) > 80) this.commit(m.m41, m.m42);
            else { 
                this.el.style.transition="0.3s ease"; 
                this.el.style.transform="translate(0,0)"; 
                if(this.oSkip) this.oSkip.style.opacity=0;
                if(this.oBrowse) this.oBrowse.style.opacity=0;
                if(this.oSelect) this.oSelect.style.opacity=0;
            }
        }
        commit(dx, dy) {
            let dir = "RIGHT";
            const a = (Math.atan2(-dy, dx) * 180 / Math.PI + 360) % 360;
            if(a>45 && a<135) dir = "UP"; else if(a>135 && a<225) dir = "LEFT"; else if(a>225 && a<315) dir = "DOWN";
            this.el.style.transition = "0.4s ease";
            this.el.style.transform = `translate(${dx*4}px, ${dy*4}px)`;
            this.el.style.opacity = "0";
            setTimeout(() => { this.cleanup(); this.cbs(dir); }, 300);
        }
    }

    // --- 3. APP LOGIC ---
    let container = document.getElementById('master-container');
    let slideElements = [], currentIdx = 0, activePhysics = null;

    async function boot() {
        renderLobby(); 
        initVoice();
        await fetchMenuData(); 
    }

    function renderLobby() {
        container.innerHTML = `
        <section class="main-slide active" id="lobby">
            <div class="slide-header"><span class="header-title">SWIPE-OS v14.4</span></div>
            <div class="lobby-container">
                <h1>AAJ KYA MANGVAAYEGE!</h1>
                <div id="cuisine-grid" style="display:grid; gap:15px;">
                    <button class="cuisine-btn" onclick="toggleCuisine('punjabi', this)">PUNJABI</button>
                    <button class="cuisine-btn" onclick="toggleCuisine('chinese', this)">CHINESE</button>
                    <button class="cuisine-btn" onclick="toggleCuisine('pizza', this)">PIZZA</button>
                    <button class="cuisine-btn" onclick="toggleCuisine('snacks', this)">NASTA PANI</button>
                </div>
                <button class="hunt-btn" onclick="startHunt()">HUNT &rarr;</button>
                <div style="display:flex;gap:10px;margin-top:15px">
                    <button id="btn-gyro" class="toggle-btn" onclick="reqGyro()">ENABLE GYRO</button>
                    <button id="btn-eye" class="toggle-btn" onclick="reqGaze()">ENABLE EYES</button>
                </div>
            </div>
        </section>`;
        slideElements = [document.getElementById('lobby')];
        if(ENGINE_STATE.cuisines_detected) ENGINE_STATE.cuisines_detected.forEach(c => { const b = document.querySelector(`button[onclick*='${c}']`); if(b) b.classList.add('selected'); });
    }

    function toggleCuisine(id, btn) {
        if(ENGINE_STATE.cuisines_detected.includes(id)) { ENGINE_STATE.cuisines_detected = ENGINE_STATE.cuisines_detected.filter(c=>c!==id); btn.classList.remove('selected'); }
        else { ENGINE_STATE.cuisines_detected.push(id); btn.classList.add('selected'); }
        localStorage.setItem("ENGINE_STATE_CACHE", JSON.stringify(ENGINE_STATE));
    }

    function reqGyro() { 
        SENSORS_ENABLED = true; 
        document.getElementById('gyro-status').classList.add('active-pill'); 
        document.getElementById('btn-gyro').classList.add('active'); // Vis Fix
        showToast("GYRO ACTIVE"); 
    }
    function reqGaze() { 
        gazeEngine.start(); 
        document.getElementById('btn-eye').classList.add('active'); // Vis Fix
        showToast("EYE TRACKING ON"); 
    }

    function startHunt() {
        if(ENGINE_STATE.cuisines_detected.length === 0) { showToast("SELECT A CUISINE"); return; }
        
        let hasSlides = false;
        container.innerHTML = ""; slideElements = [];
        ENGINE_STATE.cuisines_detected.forEach(cId => {
            if(RAW_DATA[cId]) {
                RAW_DATA[cId].categories.forEach(cat => {
                    hasSlides = true;
                    const s = document.createElement('section'); s.className = 'main-slide next'; s.id = cat.id; s.dataset.mode = 'options';
                    let h = `<div class="slide-header"><span class="header-title">${cat.label}</span></div><div class="carousel-viewport">`;
                    cat.items.forEach((item, i) => {
                        // INJECT OVERLAYS
                        h += `
                        <div class="sub-slide ${i===0?'opt-active':'opt-hidden'}" data-val="${item.name}">
                            <div class="overlay-label overlay-skip">SKIP</div>
                            <div class="overlay-label overlay-browse">BROWSE</div>
                            <div class="overlay-label overlay-select">SELECT</div>
                            <div class="role-label">${cat.label}</div>
                            <h1>${item.name} ${item.price?`<span class="price">₹${item.price}</span>`:""}</h1>
                            <div class="primary-question">Swipe / Tilt / Voice</div>
                            <div class="nav-hint"><span>SKIP</span><span>SELECT</span><span>BROWSE</span></div>
                        </div>`;
                    });
                    s.innerHTML = h + `</div>`; container.appendChild(s);
                });
            }
        });

        if(!hasSlides) { showToast("DATA ERROR"); renderLobby(); return; }

        const final = document.createElement('section'); final.className = 'main-slide next'; final.id = 'final';
        final.innerHTML = `<div class="sub-slide static"><div class="verdict-container"><div class="choice-header">FINAL ORDER</div><div class="input-group" id="final-list"></div><div class="final-actions"><button class="btn btn-zomato" onclick="link('zomato')">ZOMATO</button><button class="btn btn-swiggy" onclick="link('swiggy')">SWIGGY</button><button class="btn btn-blinkit" onclick="link('blinkit')">BLINKIT</button><button class="btn btn-cloud" onclick="saveToCloud()">SAVE</button><button class="btn btn-wa" onclick="sendWa()">WHATSAPP</button></div></div></div>`;
        container.appendChild(final);
        
        slideElements = Array.from(document.querySelectorAll('.main-slide'));
        slideElements[0].className = "main-slide active";
        currentIdx = 0;
        if(slideElements[0].dataset.mode === 'options') attachPhysics(slideElements[0].querySelector('.sub-slide'));
    }

    function attachPhysics(el) {
        if(activePhysics) activePhysics.cleanup();
        activePhysics = new PhysicsController(el, (dir) => {
            const view = slideElements[currentIdx].querySelector('.carousel-viewport');
            const val = el.dataset.val;
            if(dir === "UP") { updateCart("ADD", val); showToast("ADDED"); nextSlide(); }
            else if(dir === "LEFT") { showToast("SKIPPED"); nextSlide(); }
            else if(dir === "RIGHT") { 
                const slides = view.querySelectorAll('.sub-slide');
                let curr = 0; slides.forEach((s,i) => { if(s.classList.contains('opt-active')) curr = i; s.classList.remove('opt-active'); s.classList.add('opt-hidden'); });
                const next = slides[(curr+1)%slides.length];
                next.classList.remove('opt-hidden'); next.classList.add('opt-active');
                attachPhysics(next);
            }
            else { el.style.transform = ""; el.style.opacity = "1"; }
        });
    }

    function nextSlide() {
        if(currentIdx >= slideElements.length - 1) return;
        slideElements[currentIdx].classList.remove('active'); slideElements[currentIdx].classList.add('prev');
        currentIdx++;
        slideElements[currentIdx].classList.remove('next'); slideElements[currentIdx].classList.add('active');
        if(slideElements[currentIdx].id === 'final') renderCart();
        else if(slideElements[currentIdx].dataset.mode === 'options') attachPhysics(slideElements[currentIdx].querySelector('.sub-slide'));
    }

    function updateCart(action, item) {
        if(action === "ADD") { 
            const qty = (ENGINE_STATE.items_detected[item]?.qty || 0) + 1;
            ENGINE_STATE.items_detected[item] = { qty: qty, price: getPrice(item) };
        }
        localStorage.setItem("ENGINE_STATE_CACHE", JSON.stringify(ENGINE_STATE));
    }

    function getPrice(name) {
        for(let c in RAW_DATA) for(let cat of RAW_DATA[c].categories) for(let i of cat.items) if(i.name === name) return i.price;
        return 0;
    }

    function renderCart() {
        const list = document.getElementById('final-list');
        let h = "", total = 0;
        for(let [k,v] of Object.entries(ENGINE_STATE.items_detected)) {
            h += `<div class="input-row"><span>${k}</span><span>x${v.qty} · ₹${v.price*v.qty}</span></div>`;
            total += v.price*v.qty;
        }
        h += `<div class="input-row" style="border-top:1px solid #444;margin-top:10px"><span>TOTAL</span><span>₹${total}</span></div>`;
        list.innerHTML = h;
    }

    // --- 4. DATA FETCH ---
    async function fetchMenuData() {
        try {
            const res = await fetch(GOOGLE_SCRIPT_URL + "?type=menu");
            const json = await res.json();
            if(json.data && Object.keys(json.data).length > 0) RAW_DATA = json.data;
        } catch(e) { console.log("Using Built-in Data"); }
    }

    // --- 5. ACTIONS ---
    function executeAction(act) {
        if(document.getElementById('lobby')) return;
        const s = slideElements[currentIdx];
        if(s.dataset.mode === 'options') {
            const val = s.querySelector('.opt-active').dataset.val;
            if(act === "SELECT") { updateCart("ADD", val); showToast("ADDED"); nextSlide(); }
            if(act === "SKIP") { showToast("SKIPPED"); nextSlide(); }
            if(act === "BROWSE") {
                const view = s.querySelector('.carousel-viewport');
                const slides = view.querySelectorAll('.sub-slide');
                let curr = 0; slides.forEach((s,i) => { if(s.classList.contains('opt-active')) curr = i; s.classList.remove('opt-active'); s.classList.add('opt-hidden'); });
                const next = slides[(curr+1)%slides.length];
                next.classList.remove('opt-hidden'); next.classList.add('opt-active');
                attachPhysics(next);
            }
        }
    }

    function link(p) {
        const q = encodeURIComponent(Object.keys(ENGINE_STATE.items_detected).map(k=>`${k} x${ENGINE_STATE.items_detected[k].qty}`).join(", "));
        if(!q) return showToast("EMPTY CART");
        const urls = { zomato: `https://www.zomato.com/search?q=${q}`, swiggy: `https://www.swiggy.com/search?query=${q}`, blinkit: `https://blinkit.com/s/?q=${q}` };
        window.open(urls[p], '_blank');
    }
    function sendWa() {
        let msg = "ORDER:\n"; for(let [k,v] of Object.entries(ENGINE_STATE.items_detected)) msg += `${k} x${v.qty}\n`;
        window.open(`https://wa.me/916351537770?text=${encodeURIComponent(msg)}`, '_blank');
    }
    function saveToCloud() { fetch(GOOGLE_SCRIPT_URL, {method:"POST", body:JSON.stringify(ENGINE_STATE)}); showToast("SAVED"); }
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('visible'); setTimeout(()=>t.classList.remove('visible'),2000); }
    
    // --- 6. VOICE ---
    function toggleListenMode() { 
        if(!rec) initVoice();
        const m = document.getElementById('mic-toggle');
        if(m.classList.contains('listening')) { rec.stop(); m.classList.remove('listening'); } else { rec.start(); m.classList.add('listening'); }
    }
    let rec;
    function initVoice() {
        if(!window.SpeechRecognition && !window.webkitSpeechRecognition) return;
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        rec = new SR(); rec.lang = "en-IN"; rec.continuous = true;
        rec.onresult = e => {
            const t = e.results[e.results.length-1][0].transcript.toLowerCase();
            showToast(t);
            if(t.includes("zomato")) link('zomato');
            else if(t.includes("swiggy")) link('swiggy');
            else if(t.includes("whatsapp")) sendWa();
            else if(t.includes("select") || t.includes("add")) executeAction("SELECT");
            else if(t.includes("skip") || t.includes("next")) executeAction("SKIP");
            else {
                const nums = {"one":1,"two":2,"three":3,"1":1,"2":2,"3":3};
                for(let k in nums) if(t.includes(k)) { 
                    const s = slideElements[currentIdx];
                    if(s && s.dataset.mode === 'options') {
                         const val = s.querySelector('.opt-active').dataset.val;
                         ENGINE_STATE.items_detected[val] = { qty: nums[k], price: getPrice(val) };
                         showToast(`ADDED ${nums[k]} ${val}`);
                         nextSlide();
                    }
                }
            }
        };
        rec.onend = () => { if(document.getElementById('mic-toggle').classList.contains('listening')) rec.start(); };
    }

    boot();
</script>
</body>
</html>
