<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>| food.decide | Unified</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="background-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <script src="https://webgazer.cs.brown.edu/webgazer.js" async></script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js').catch(e=>{});
        });
      }
    </script>

    <style>
        /* =========================================
           CORE SYSTEM (v11.0 Base)
           ========================================= */
        :root {
            --brand-orange: #ff671f;
            --brand-bg: #0a0a0a;
            --text-main: #f0f0f0;
            --accent-go: #00e676; 
            --accent-skip: #ff3333;
            --accent-zomato: #cb202d;
            --accent-swiggy: #fc8019;
            --accent-blinkit: #f8cb46;
            --font-tech: 'Courier New', monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--brand-bg);
            color: var(--text-main);
            font-family: var(--font-ui);
            overflow: hidden;
            touch-action: none; 
        }

        #master-container { height: 100vh; width: 100vw; position: relative; overflow: hidden; }

        .main-slide {
            height: 100vh; width: 100vw; position: absolute; top: 0; left: 0;
            display: flex; flex-direction: column; background: var(--brand-bg);
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform;
        }
        .main-slide.prev { transform: translateY(-100%); }
        .main-slide.active { transform: translateY(0); z-index: 10; }
        .main-slide.next { transform: translateY(100%); z-index: 20; }

        .slide-header { padding: 20px; border-left: 3px solid var(--brand-orange); height: 70px; flex-shrink: 0; z-index: 10; display: flex; align-items: center; }
        .header-title { font-family: var(--font-tech); font-size: 0.75rem; color: var(--brand-orange); letter-spacing: 1px; font-weight: 700; text-transform: uppercase; }

        .carousel-viewport { position: relative; flex-grow: 1; width: 100%; height: 100%; }

        .sub-slide {
            position: absolute; inset: 0; padding: 25px;
            display: flex; flex-direction: column; justify-content: center;
            opacity: 0; pointer-events: none;
            transform: translateX(20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            overflow: hidden; /* For overlays */
        }
        .sub-slide.opt-active { z-index: 30; opacity: 1; pointer-events: auto; transform: translateX(0); }
        .sub-slide.opt-hidden { z-index: 0; opacity: 0; pointer-events: none; }
        .sub-slide.static { z-index: 30; opacity: 1; pointer-events: auto; transform: none; }

        /* UPGRADE: Gyro Feedback Overlays */
        .overlay-label {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-family: var(--font-tech); font-size: 3rem; font-weight: 900; 
            letter-spacing: 4px; text-transform: uppercase;
            opacity: 0; pointer-events: none; z-index: 50; 
            transition: opacity 0.1s linear;
        }
        .overlay-skip { background: rgba(255, 51, 51, 0.15); color: var(--accent-skip); transform: rotate(-10deg); }
        .overlay-browse { background: rgba(66, 133, 244, 0.15); color: #4285F4; transform: rotate(10deg); }
        .overlay-select { background: rgba(0, 230, 118, 0.15); color: var(--accent-go); flex-direction: column; justify-content: flex-end; padding-bottom: 100px; }

        h1 { font-size: 1.8rem; margin: 0 0 15px 0; line-height: 1; letter-spacing: -1px; color: var(--brand-orange); position: relative; z-index: 10; }
        .primary-question { font-size: 1.1rem; color: #fff; margin-bottom: 25px; line-height: 1.4; font-weight: 600; position: relative; z-index: 10; }
        .price { font-size: 0.9rem; color: #aaa; margin-left: 10px; font-family: var(--font-tech); background: #222; padding: 2px 6px; border-radius: 4px; }
        .role-label { font-family: var(--font-tech); font-size: 0.6rem; color: #000; background: var(--accent-go); padding: 4px 8px; border-radius: 4px; width: fit-content; margin-bottom: 15px; font-weight: bold; position: relative; z-index: 10; }
        .nav-hint { margin-top: 30px; padding-top: 20px; border-top: 1px solid #333; font-family: var(--font-tech); font-size: 0.7rem; color: #666; display: flex; justify-content: space-between; position: relative; z-index: 10; }

        .verdict-container { display: flex; flex-direction: column; height: 100%; justify-content: center; }
        .choice-header { font-family: var(--font-tech); color: #666; font-size: 0.8rem; margin-bottom: 20px; text-transform: uppercase; text-align: center; }
        .input-group { border: 1px solid #333; background: #111; padding: 20px; border-radius: 8px; margin-bottom: 20px; min-height: 100px; max-height: 40vh; overflow-y: auto; }
        .input-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #333; padding: 10px 0; font-family: var(--font-tech); font-size: 0.8rem; }
        .input-key { color: #888; text-transform: uppercase; } .input-val { color: var(--accent-go); font-weight: bold; text-align: right; }
        .final-actions { display: grid; gap: 10px; margin-top: 20px; }
        .btn { background: #222; color: #fff; border: 1px solid #333; padding: 15px; border-radius: 8px; font-weight: 600; text-align: center; font-size: 0.9rem; cursor: pointer; display: block; width: 100%; box-sizing: border-box;}
        .btn-wa { background: #25D366; color: #000; border: none; } .btn-zomato { background: var(--accent-zomato); border: none; opacity: 0.5; } .btn-swiggy { background: var(--accent-swiggy); border: none; opacity: 0.5; } .btn-blinkit { background: var(--accent-blinkit); color: #000; border: none; opacity: 0.5; } .btn-cloud { background: #4285F4; border: none; opacity: 1; }
        .btn-zomato.active, .btn-swiggy.active, .btn-blinkit.active { opacity: 1; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .biz-card { background: linear-gradient(145deg, #111, #050505); border: 1px solid var(--brand-orange); padding: 30px; border-radius: 12px; text-align: center; }
        .biz-tagline { font-family: var(--font-tech); color: var(--brand-orange); font-size: 0.7rem; margin-bottom: 10px; display: block; } .biz-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 20px; color: #fff; }

        .lobby-container { display: flex; flex-direction: column; gap: 15px; padding: 30px; height: 100%; justify-content: center; }
        .cuisine-btn { background: #222; border: 1px solid #444; color: #888; padding: 20px; font-size: 1.2rem; font-weight: bold; text-transform: uppercase; border-radius: 12px; transition: all 0.2s; }
        .cuisine-btn.selected { background: var(--brand-orange); color: #000; border-color: var(--brand-orange); box-shadow: 0 0 15px rgba(255, 103, 31, 0.4); }
        .hunt-btn { background: #fff; color: #000; font-weight: 900; margin-top: 30px; letter-spacing: 2px; padding:15px; border:none; border-radius:8px;}

        /* UPGRADE: STATUS PILLS */
        #depth-fill { position: fixed; right: 0; top: 0; bottom: 0; width: 4px; background: #333; z-index: 900; height: 0%; transition: height 0.05s linear; }
        .toast-msg { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #222; color: #00e676; padding: 10px 20px; border: 1px solid #00e676; border-radius: 20px; font-size: 0.8rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 3000; white-space: nowrap; font-family: var(--font-tech); } .toast-msg.visible { opacity: 1; }
        #mic-toggle { position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; background: #111; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #444; z-index: 2000; cursor: pointer; transition: all 0.3s; } #mic-toggle svg { width: 24px; height: 24px; fill: #666; } #mic-toggle.listening { border-color: var(--accent-go); box-shadow: 0 0 15px rgba(0,230,118,0.3); } #mic-toggle.listening svg { fill: var(--accent-go); }
        
        #gaze-dot { position: fixed; width: 10px; height: 10px; background: var(--brand-orange); border-radius: 50%; z-index: 9999; pointer-events: none; display: none; transform: translate(-50%, -50%); box-shadow: 0 0 10px var(--brand-orange); }
        .status-pill { position: fixed; left: 50%; transform: translateX(-50%); font-family: var(--font-tech); font-size: 0.6rem; color: #444; border: 1px solid #333; padding: 4px 8px; border-radius: 4px; opacity: 0; transition: opacity 0.5s; z-index: 1000; pointer-events: none; background:#000; }
        #gyro-status { top: 15px; } #eye-status { top: 40px; }
        .status-pill.active { opacity: 1; color: var(--accent-go); border-color: var(--accent-go); }
    </style>
</head>
<body>

<div id="gyro-status" class="status-pill">GYRO ACTIVE</div>
<div id="eye-status" class="status-pill">EYE TRACKING</div>
<div id="gaze-dot"></div>

<div id="master-container"></div>
<div id="depth-fill"></div>
<div id="toast" class="toast-msg"></div>

<div id="mic-toggle" onclick="toggleListenMode()">
    <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyBMwKxq92U0dptKMdEHvUCXPS9AjExHtxHjcRmfh2JFjCSn9Zd82bzp34xLg6X0a7L9g/exec";
    const SHARE_LINK_TEXT = "food-decider | swipe OS";
    const NET_STATE = { online: navigator.onLine };
    window.addEventListener("online", () => { NET_STATE.online = true; showToast("ONLINE"); fetchVoiceConfig(); });
    window.addEventListener("offline", () => { NET_STATE.online = false; showToast("OFFLINE"); });

    const FALLBACK_MENU = {
        version: "offline-v1",
        data: {
            punjabi: { label: "PUNJABI", categories: [{ id: "p_breads", label: "Breads", items: [{name:"Butter Naan", price:40}, {name:"Tandoori Roti", price:25}] }, { id: "p_mains", label: "Mains", items: [{name:"Dal Makhani", price:220}, {name:"Paneer Butter Masala", price:240}] }] },
            chinese: { label: "CHINESE", categories: [{ id: "c_dimsum", label: "Dim Sum", items: [{name:"Veg Crystal Dumpling", price:220}] }, { id: "c_noodles", label: "Noodles", items: [{name:"Hakka Noodles", price:200}] }] },
            pizza: { label: "PIZZA", categories: [{ id: "z_classic", label: "Classic", items: [{name:"Margherita", price:350}] }] },
            snacks: { label: "NASTA PANI", categories: [{ id: "s_hot", label: "Hot Snacks", items: [{name:"Samosa", price:20}] }] }
        }
    };
    let RAW_DATA = FALLBACK_MENU.data; 

    /* --- 4-INPUT STATE --- */
    let TILT_ENABLED = false;
    let GAZE_ENABLED = false;
    let lastInputTs = 0;
    let TOUCH_ACTIVE = false;

    // Arbitration: Touch Overrides Everything
    document.addEventListener("touchstart", ()=> { TOUCH_ACTIVE = true; }, {passive:true});
    document.addEventListener("touchend", ()=> { TOUCH_ACTIVE = false; }, {passive:true});

    /* --- GYRO ENGINE --- */
    const TILT = { X_NEXT: 25, X_PREV: -25, Y_SELECT: 30, Y_SKIP: -30, COOLDOWN: 100 };
    
    function enableTilt() {
      if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function") {
        DeviceOrientationEvent.requestPermission().then(res => { if (res === "granted") attachTilt(); });
      } else { attachTilt(); }
    }
    function attachTilt() {
      window.addEventListener("deviceorientation", handleTilt, { passive: true });
      TILT_ENABLED = true;
      document.getElementById('gyro-status').classList.add('active');
    }

    function handleTilt(e) {
      if (!TILT_ENABLED || TOUCH_ACTIVE) return;
      const currSlide = slideElements[currentIdx];
      if (!currSlide || currSlide.dataset.mode !== "options") return;

      const x = e.gamma; // Left/Right
      const y = e.beta;  // Up/Down

      // UPDATE VISUALS (The "Come to Life" Feature)
      const oSkip = currSlide.querySelector('.overlay-skip');
      const oBrowse = currSlide.querySelector('.overlay-browse');
      const oSelect = currSlide.querySelector('.overlay-select');
      
      const opX = Math.min(Math.abs(x)/40, 1);
      const opY = Math.min(Math.abs(y)/40, 1);

      if(oSkip) oSkip.style.opacity = (x < -10) ? opX : 0;
      if(oBrowse) oBrowse.style.opacity = (x > 10) ? opX : 0;
      if(oSelect) oSelect.style.opacity = (y < -10) ? opY : 0; // Tilt Up (phone top away) is usually negative beta

      // TRIGGER ACTION
      const now = Date.now();
      if (now - lastInputTs < TILT.COOLDOWN) return;

      if (x > TILT.X_NEXT) { executeAction("BROWSE"); lastInputTs = now; }
      else if (x < TILT.X_PREV) { executeAction("SKIP"); lastInputTs = now; }
      else if (y < -TILT.Y_SELECT) { executeAction("SELECT"); lastInputTs = now; } // Fixed direction
    }

    /* --- EYE TRACKING ENGINE --- */
    function enableGaze() {
        if(typeof webgazer === 'undefined') return;
        GAZE_ENABLED = true;
        document.getElementById('eye-status').classList.add('active');
        document.getElementById('gaze-dot').style.display = 'block';
        
        webgazer.setGazeListener((data, elapsed) => {
            if (data == null || TOUCH_ACTIVE || !GAZE_ENABLED) return;
            const dot = document.getElementById('gaze-dot');
            dot.style.left = data.x + 'px'; dot.style.top = data.y + 'px';
            
            if (Date.now() - lastInputTs > 1500) { // Slower cadence for eyes
                if (data.y < window.innerHeight * 0.2) { executeAction("SELECT"); lastInputTs = Date.now(); }
                else if (data.x < window.innerWidth * 0.2) { executeAction("SKIP"); lastInputTs = Date.now(); }
                else if (data.x > window.innerWidth * 0.8) { executeAction("BROWSE"); lastInputTs = Date.now(); }
            }
        }).begin();
    }

    async function fetchMenuData() {
        const timeout = new Promise((_, reject) => setTimeout(() => reject("Timeout"), 3000));
        try {
            const fetcher = fetch(GOOGLE_SCRIPT_URL + "?type=menu", { cache: "no-store" });
            const res = await Promise.race([fetcher, timeout]);
            const json = await res.json();
            if (json.data) RAW_DATA = json.data;
        } catch (e) { console.warn("MENU: USING BACKUP"); }
    }

    let ENGINE_STATE = { session_id: "auto-" + Date.now(), cuisines_detected: [], items_detected: {}, platform_strategy: { fulfillment: [] } };

    function findItemPrice(name) {
        if (!RAW_DATA) return 0;
        for (let c in RAW_DATA) for (let cat of RAW_DATA[c].categories) for (let item of cat.items) if (item.name.toLowerCase() === name.toLowerCase()) return item.price || 0;
        return 0;
    }

    function engineUpdate(patchType, payload) {
        if (patchType === "ADD_CUISINE") if(!ENGINE_STATE.cuisines_detected.includes(payload)) ENGINE_STATE.cuisines_detected.push(payload);
        if (patchType === "REMOVE_CUISINE") ENGINE_STATE.cuisines_detected = ENGINE_STATE.cuisines_detected.filter(c => c !== payload);
        if (patchType === "ADD_ITEM") {
            const qty = ENGINE_STATE.items_detected[payload] ? ENGINE_STATE.items_detected[payload].qty + 1 : 1;
            ENGINE_STATE.items_detected[payload] = { qty: qty, price: findItemPrice(payload) };
        }
        if (patchType === "REMOVE_ITEM") delete ENGINE_STATE.items_detected[payload];
        if (patchType === "RESET") { ENGINE_STATE.items_detected = {}; ENGINE_STATE.cuisines_detected = []; }
        updateResult();
    }

    function updateResult() {
        const list = document.getElementById('final-list');
        if(!list) return;
        let html = '', total = 0;
        for (const [name, data] of Object.entries(ENGINE_STATE.items_detected)) {
            total += data.price * data.qty;
            html += `<div class="input-row"><span class="input-key">${name}</span><span class="input-val">x${data.qty} Â· â‚¹${data.price * data.qty}</span></div>`;
        }
        html += `<div class="input-row" style="border-top:1px solid #444; margin-top:10px;"><span class="input-key">TOTAL</span><span class="input-val">â‚¹${total}</span></div>`;
        list.innerHTML = html;
    }

    const container = document.getElementById('master-container');
    let slideElements = [], currentIdx = 0;

    function renderLobby() {
        container.innerHTML = "";
        const section = document.createElement('section');
        section.className = "main-slide active"; section.id = "lobby";
        section.innerHTML = `
        <div class="slide-header"><span class="header-title">SWIPE-OS v15.0</span></div>
        <div class="lobby-container">
            <h1 style="text-align:center; margin-bottom:40px;">AAJ KYA MANGVAAYEGE!</h1>
            <div id="cuisine-grid" style="display:grid; gap:15px;">
                <button class="cuisine-btn" onclick="toggleCuisine('punjabi', this)">PUNJABI</button>
                <button class="cuisine-btn" onclick="toggleCuisine('chinese', this)">CHINESE</button>
                <button class="cuisine-btn" onclick="toggleCuisine('pizza', this)">PIZZA</button>
                <button class="cuisine-btn" onclick="toggleCuisine('snacks', this)">NASTA PANI</button>
            </div>
            <button class="btn hunt-btn" onclick="startHunt()">HUNT &rarr;</button>
            <div style="display:flex; gap:10px; margin-top:20px;">
               <button class="btn" style="flex:1; background:#222; font-size:0.7rem;" onclick="enableTilt()">ENABLE GYRO</button>
               <button class="btn" style="flex:1; background:#222; font-size:0.7rem;" onclick="enableGaze()">ENABLE EYES</button>
            </div>
        </div>`;
        container.appendChild(section);
        slideElements = [section]; currentIdx = 0;
    }

    window.toggleCuisine = (id, btn) => {
        if(ENGINE_STATE.cuisines_detected.includes(id)) { engineUpdate("REMOVE_CUISINE", id); btn.classList.remove('selected'); }
        else { engineUpdate("ADD_CUISINE", id); btn.classList.add('selected'); }
    };

    window.startHunt = () => {
        if(ENGINE_STATE.cuisines_detected.length === 0) { showToast("SELECT ONE!"); return; }
        buildGameDeck();
    };

    function buildGameDeck() {
        container.innerHTML = ""; let slides = [];
        ENGINE_STATE.cuisines_detected.forEach(cId => {
            if(RAW_DATA[cId]) RAW_DATA[cId].categories.forEach(cat => slides.push({ id: cat.id, type: 'selector', title: `${RAW_DATA[cId].label} Â· ${cat.label.toUpperCase()}`, items: cat.items }));
        });
        slides.push({ id: "final", type: "final", title: "FINAL ORDER" });
        
        slides.forEach((cfg, idx) => {
            const section = document.createElement('section');
            section.className = `main-slide ${idx === 0 ? 'active' : 'next'}`; section.id = cfg.id; section.dataset.mode = cfg.type === 'selector' ? 'options' : 'static';
            let html = `<div class="slide-header"><span class="header-title">${cfg.title}</span></div><div class="carousel-viewport" data-id="${cfg.id}">`;
            
            if (cfg.type === 'selector') {
                cfg.items.forEach((item, i) => {
                    // ðŸ†• INJECTING OVERLAYS FOR GYRO FEEDBACK
                    html += `
                    <div class="sub-slide ${i===0 ? 'opt-active' : 'opt-hidden'}" data-opt-idx="${i}" data-val="${item.name}">
                        <div class="overlay-label overlay-skip">SKIP</div>
                        <div class="overlay-label overlay-browse">BROWSE</div>
                        <div class="overlay-label overlay-select">SELECT</div>
                        <div class="role-label">${cfg.title.split('Â·')[0].trim()}</div>
                        <h1>${item.name} ${item.price ? `<span class="price">â‚¹${item.price}</span>` : ""}</h1>
                        <div class="primary-question">Swipe / Tilt / Voice</div>
                        <div class="nav-hint"><span style="flex:1; color:var(--accent-skip); font-weight:bold;">&larr; SKIP</span><span style="flex:2; text-align:center; color:var(--accent-go); font-weight:bold;">&darr; SELECT</span><span style="flex:1; text-align:right;">BROWSE &rarr;</span></div>
                    </div>`;
                });
            } else if (cfg.type === 'final') {
                html += `<div class="sub-slide static"><div class="verdict-container"><div class="choice-header">WHAT YOU CHOSE</div><div class="input-group" id="final-list"></div><div class="final-actions"><button class="btn btn-zomato" onclick="copyAndRedirect('zomato')">ZOMATO</button><button class="btn btn-swiggy" onclick="copyAndRedirect('swiggy')">SWIGGY</button><button class="btn btn-blinkit" onclick="copyAndRedirect('blinkit')">BLINKIT</button><button class="btn btn-wa" onclick="sendWhatsapp()">WHATSAPP</button></div></div></div>`;
            }
            html += `</div>`; section.innerHTML = html; container.appendChild(section);
        });
        slideElements = Array.from(document.querySelectorAll('.main-slide')); currentIdx = 0;
        attachEvents(); updateResult();
    }

    let dragRatio = 0; const MAX_DRAG = 250;
    function goToSlide(idx) {
        if (idx < 0 || idx >= slideElements.length) return;
        slideElements[currentIdx].classList.remove('active');
        if (idx > currentIdx) slideElements[currentIdx].classList.add('prev'); else slideElements[currentIdx].classList.add('next');
        slideElements[currentIdx].classList.remove(idx > currentIdx ? 'next' : 'prev');
        currentIdx = idx;
        const next = slideElements[currentIdx]; next.classList.remove('prev', 'next'); next.classList.add('active');
        if(next.id === 'final') updateResult();
        document.getElementById('depth-fill').style.height = '0%';
    }

    function executeAction(action) {
        lastInputTs = Date.now(); // Reset timers
        const currSlide = slideElements[currentIdx];
        const mode = currSlide.dataset.mode;
        
        switch(action) {
            case 'NEXT': goToSlide(currentIdx + 1); break;
            case 'PREV': if(currentIdx > 0) goToSlide(currentIdx - 1); break;
            case 'SELECT': 
                if(mode === 'options') {
                    const view = currSlide.querySelector('.carousel-viewport');
                    const val = view.querySelectorAll('.sub-slide')[view._currOpt || 0].dataset.val;
                    engineUpdate("ADD_ITEM", val); showToast(`SELECTED: ${val}`); goToSlide(currentIdx + 1);
                } else goToSlide(currentIdx + 1); break;
            case 'SKIP': if(mode === 'options') { showToast("SKIPPED", "skip"); goToSlide(currentIdx + 1); } break;
            case 'BROWSE': if(mode === 'options') {
                    const view = currSlide.querySelector('.carousel-viewport');
                    const slides = view.querySelectorAll('.sub-slide');
                    let curr = view._currOpt || 0; 
                    slides[curr].classList.remove('opt-active'); slides[curr].classList.add('opt-hidden');
                    curr = (curr + 1) % slides.length; view._currOpt = curr;
                    slides[curr].classList.remove('opt-hidden'); slides[curr].classList.add('opt-active');
                } break;
        }
    }

    function attachEvents() {
        let startX = 0, startY = 0;
        document.querySelectorAll('.carousel-viewport').forEach(view => {
            view._currOpt = 0;
            view.addEventListener('touchstart', e => { startX = e.touches[0].clientX; startY = e.touches[0].clientY; }, {passive: true});
            view.addEventListener('touchmove', e => {
                const dx = e.touches[0].clientX - startX; const dy = e.touches[0].clientY - startY;
                const axis = Math.abs(dx) > Math.abs(dy) ? 'x' : 'y';
                if(axis === 'y' && dy > 0) { e.preventDefault(); dragRatio = Math.min(dy/MAX_DRAG, 1); document.getElementById('depth-fill').style.height = (dragRatio*100)+'%'; }
            }, {passive: false});
            view.addEventListener('touchend', e => {
                const dx = e.changedTouches[0].clientX - startX; const dy = e.changedTouches[0].clientY - startY;
                const axis = Math.abs(dx) > Math.abs(dy) ? 'x' : 'y';
                if (axis === 'y') { if (dy < -50) executeAction('PREV'); else if (dy > 50 && dragRatio > 0.9) executeAction('SELECT'); }
                else if (axis === 'x' && view.closest('.main-slide').dataset.mode === 'options') { if (dx < -50) executeAction('SKIP'); else if (dx > 50) executeAction('BROWSE'); }
                document.getElementById('depth-fill').style.height = '0%';
            });
        });
    }

    function dispatchVoice(cmd){
      if(!cmd) return;
      if(document.getElementById('lobby')) { if(cmd.key === 'next' || cmd.key === 'jump') startHunt(); return; }
      lastInputTs = Date.now();
      switch(cmd.group){
        case "NAV": if(cmd.key==="next") executeAction("NEXT"); if(cmd.key==="prev") executeAction("PREV"); break;
        case "ACTION": if(cmd.key==="select") executeAction("SELECT"); if(cmd.key==="skip") executeAction("SKIP"); if(cmd.key==="browse") executeAction("BROWSE"); break;
        case "PLATFORM": copyAndRedirect(cmd.key); break;
      }
    }

    function copyAndRedirect(platform) {
        const text = "ORDER: " + Object.keys(ENGINE_STATE.items_detected).join(", ");
        if(platform === 'whatsapp') { window.open(`https://wa.me/916351537770?text=${encodeURIComponent(text)}`); return; }
        // Fixed URL Deep Linking
        const links = { 
            zomato: `https://www.zomato.com/search?q=${text}`, 
            swiggy: `https://www.swiggy.com/search?query=${text}`, 
            blinkit: `https://blinkit.com/s/?q=${text}` 
        };
        window.open(links[platform]);
    }

    function sendWhatsapp() { copyAndRedirect('whatsapp'); }

    function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2000); }

    let rec;
    function initVoice() {
        if(!window.SpeechRecognition && !window.webkitSpeechRecognition) return;
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        rec = new SR(); rec.lang = "en-IN"; rec.continuous = true;
        rec.onresult = e => {
            const txt = e.results[e.results.length - 1][0].transcript.toLowerCase();
            showToast(`"${txt}"`);
            if (txt.includes("next")) dispatchVoice({group:"NAV", key:"next"});
            if (txt.includes("select")) dispatchVoice({group:"ACTION", key:"select"});
            if (txt.includes("skip")) dispatchVoice({group:"ACTION", key:"skip"});
            if (txt.includes("zomato")) dispatchVoice({group:"PLATFORM", key:"zomato"});
            if (txt.includes("browse")) dispatchVoice({group:"ACTION", key:"browse"});
        };
        rec.start();
    }
    
    function toggleListenMode() {
        if(!TILT_ENABLED) enableTilt(); // Auto-enable tilt with mic
        if(rec) try { rec.start(); } catch(e){} 
        document.getElementById('mic-toggle').classList.add('listening');
    }

    renderLobby();
    fetchMenuData();
</script>
</body>
</html>
