<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>| food.decide | v16.4</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="background-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <script src="https://webgazer.cs.brown.edu/webgazer.js" async></script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
        });
      }
    </script>

    <style>
        :root { --orange: #ff671f; --bg: #0a0a0a; --text: #f0f0f0; --go: #00e676; --red: #ff3333; --blue: #4285F4; --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; --mono: 'Courier New', monospace; }
        
        html, body { margin:0; padding:0; height:100%; width:100%; background:var(--bg); color:var(--text); font-family:var(--font); overflow:hidden; touch-action:none; }
        #master-container { height: 100vh; width: 100vw; position: relative; overflow: hidden; }

        /* SENSOR STATUS */
        .status-pill { position: fixed; left: 50%; transform: translateX(-50%); font-family: var(--mono); font-size: 0.6rem; color: #444; border: 1px solid #333; padding: 4px 8px; border-radius: 4px; opacity: 0; transition: opacity 0.5s; z-index: 1000; pointer-events: none; background: #000; }
        #gyro-status { top: 15px; } #eye-status { top: 40px; }
        .active-pill { opacity: 1 !important; color: var(--go) !important; border-color: var(--go) !important; }
        #gaze-dot { position: fixed; width: 10px; height: 10px; background: var(--orange); border-radius: 50%; z-index: 9999; pointer-events: none; display: none; transform: translate(-50%, -50%); box-shadow: 0 0 10px var(--orange); }

        /* SLIDES */
        .main-slide { height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; background: var(--bg); transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); will-change: transform; }
        .main-slide.prev { transform: translateY(-100%); } .main-slide.active { transform: translateY(0); z-index: 10; } .main-slide.next { transform: translateY(100%); z-index: 20; }

        .slide-header { padding: 20px; border-left: 3px solid var(--orange); height: 70px; flex-shrink: 0; z-index: 10; display: flex; align-items: center; }
        .header-title { font-family: var(--mono); font-size: 0.75rem; color: var(--orange); letter-spacing: 1px; font-weight: 700; text-transform: uppercase; }
        
        .carousel-viewport { position: relative; flex-grow: 1; width: 100%; height: 100%; }
        
        .sub-slide { 
            position: absolute; inset: 0; padding: 25px; display: flex; flex-direction: column; justify-content: center; 
            opacity: 0; pointer-events: none; background: var(--bg); border-radius: 12px; 
            transform-origin: 50% 150%; 
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s; 
            will-change: transform; 
            overflow: hidden; 
        }
        .sub-slide.opt-active { z-index: 30; opacity: 1; pointer-events: auto; transform: translateX(0); }
        .sub-slide.opt-hidden { z-index: 0; opacity: 0; pointer-events: none; transform: scale(0.9); }
        .sub-slide.static { z-index: 30; opacity: 1; pointer-events: auto; transform: none; }

        /* GYRO OVERLAYS */
        .overlay-label {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-family: var(--mono); font-size: 2.5rem; font-weight: 900; letter-spacing: 2px; text-transform: uppercase;
            opacity: 0; pointer-events: none; z-index: 50; transition: opacity 0.05s linear;
        }
        .overlay-skip { background: rgba(255, 51, 51, 0.15); color: var(--red); transform: rotate(-10deg); }
        .overlay-browse { background: rgba(66, 133, 244, 0.15); color: var(--blue); transform: rotate(10deg); }
        .overlay-select { background: rgba(0, 230, 118, 0.15); color: var(--go); flex-direction: column; justify-content: flex-end; padding-bottom: 100px; }

        /* UI ELEMENTS */
        h1 { font-size: 1.8rem; margin: 0 0 15px 0; line-height: 1; letter-spacing: -1px; color: var(--orange); position: relative; z-index: 10; }
        .primary-question { font-size: 1.1rem; color: #fff; margin-bottom: 25px; font-weight: 600; position: relative; z-index: 10; }
        .price { font-size: 0.9rem; color: #aaa; margin-left: 10px; font-family: var(--mono); background: #222; padding: 2px 6px; border-radius: 4px; }
        .role-label { font-family: var(--mono); font-size: 0.6rem; color: #000; background: var(--go); padding: 4px 8px; border-radius: 4px; width: fit-content; margin-bottom: 15px; font-weight: bold; position: relative; z-index: 10; }
        .nav-hint { margin-top: 30px; padding-top: 20px; border-top: 1px solid #333; font-family: var(--mono); font-size: 0.7rem; color: #666; display: flex; justify-content: space-between; position: relative; z-index: 10; }

        .lobby-container { display: flex; flex-direction: column; gap: 15px; padding: 30px; height: 100%; justify-content: center; }
        .cuisine-btn { background: #222; border: 1px solid #444; color: #888; padding: 20px; font-size: 1.2rem; font-weight: bold; text-transform: uppercase; border-radius: 12px; transition: all 0.2s; }
        .cuisine-btn.selected { background: var(--orange); color: #000; border-color: var(--orange); box-shadow: 0 0 15px rgba(255, 103, 31, 0.4); }
        .hunt-btn { background: #fff; color: #000; font-weight: 900; margin-top: 30px; letter-spacing: 2px; padding: 15px; border-radius: 8px; border: none; cursor: pointer;}
        
        .toggle-btn {
            background: transparent; border: 1px solid #666; color: #ccc; font-family: var(--mono); font-size: 0.7rem; font-weight: bold;
            flex: 1; padding: 15px; border-radius: 8px; transition: all 0.3s; cursor: pointer;
        }
        .toggle-btn.active { border-color: var(--go); color: var(--go); background: rgba(0, 230, 118, 0.1); box-shadow: 0 0 15px rgba(0, 230, 118, 0.2); }

        .final-actions { display: grid; gap: 10px; margin-top: 20px; }
        .btn { background: #222; color: #fff; border: 1px solid #333; padding: 15px; border-radius: 8px; font-weight: 600; text-align: center; font-size: 0.9rem; cursor: pointer; width: 100%; box-sizing: border-box;}
        .btn-zomato { background: #cb202d; opacity: 0.5; border:none;} .btn-swiggy { background: #fc8019; opacity: 0.5; border:none;} .btn-blinkit { background: #f8cb46; color: #000; opacity: 0.5; border:none;}
        .btn-wa { background: #25D366; color: #000; border: none; } .btn-cloud { background: #4285F4; border: none; }
        .btn-zomato.active, .btn-swiggy.active, .btn-blinkit.active { opacity: 1; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        
        .verdict-container { display: flex; flex-direction: column; height: 100%; justify-content: center; }
        .choice-header { font-family: var(--mono); color: #666; font-size: 0.8rem; margin-bottom: 20px; text-transform: uppercase; text-align: center; }
        .input-group { border: 1px solid #333; background: #111; padding: 20px; border-radius: 8px; margin-bottom: 20px; min-height: 100px; max-height: 40vh; overflow-y: auto; }
        .input-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #333; padding: 10px 0; font-family: var(--mono); font-size: 0.8rem; }
        .input-key { color: #888; text-transform: uppercase; } .input-val { color: var(--go); font-weight: bold; text-align: right; }
        
        .biz-card { background: linear-gradient(145deg, #111, #050505); border: 1px solid var(--orange); padding: 30px; border-radius: 12px; text-align: center; }
        .biz-tagline { font-family: var(--mono); color: var(--orange); font-size: 0.7rem; margin-bottom: 10px; display: block; } .biz-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 20px; color: #fff; }

        /* v11 PHYSICS UI */
        #depth-fill { position: fixed; right: 0; top: 0; bottom: 0; width: 4px; background: #333; z-index: 900; height: 0%; transition: height 0.05s linear; }

        #mic-toggle { position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; background: #111; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #444; z-index: 2000; cursor: pointer; transition: all 0.3s; }
        #mic-toggle svg { width: 24px; height: 24px; fill: #666; }
        #mic-toggle.listening { border-color: var(--go); box-shadow: 0 0 15px rgba(0,230,118,0.3); }
        #mic-toggle.listening svg { fill: var(--go); }
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #222; color: #00e676; padding: 10px 20px; border: 1px solid #00e676; border-radius: 20px; font-family: var(--mono); font-size: 0.8rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 3000; white-space: nowrap; }
        #toast.visible { opacity: 1; }
    </style>
</head>
<body>

<div id="gyro-status" class="status-pill">GYRO ACTIVE</div>
<div id="eye-status" class="status-pill">EYE TRACKING</div>
<div id="gaze-dot"></div>

<div id="master-container"></div>
<div id="depth-fill"></div>
<div id="toast" class="toast-msg"></div>

<div id="mic-toggle" onclick="toggleListenMode()">
    <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
</div>

<script>
    // --- 1. DATA (IMMEDIATE LOAD) ---
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyBMwKxq92U0dptKMdEHvUCXPS9AjExHtxHjcRmfh2JFjCSn9Zd82bzp34xLg6X0a7L9g/exec";
    let SENSORS_ENABLED = false;
    let GAZE_ENABLED = false;
    
    // HARDCODED MENU (Source of Truth)
    const RAW_DATA = {
        "punjabi": {
          "label": "PUNJABI",
          "categories": [
            { "id": "p_breads", "label": "Breads", "items": [ { "name": "Butter Naan", "price": 40 }, { "name": "Garlic Naan", "price": 50 }, { "name": "Tandoori Roti", "price": 25 }, { "name": "Lachha Paratha", "price": 55 } ] },
            { "id": "p_mains", "label": "Mains", "items": [ { "name": "Dal Makhani", "price": 220 }, { "name": "Paneer Butter Masala", "price": 240 }, { "name": "Shahi Paneer", "price": 250 }, { "name": "Butter Chicken", "price": 280 }, { "name": "Kadai Paneer", "price": 230 } ] },
            { "id": "p_rice", "label": "Rice", "items": [ { "name": "Jeera Rice", "price": 150 }, { "name": "Veg Pulao", "price": 160 }, { "name": "Chicken Biryani", "price": 290 } ] },
            { "id": "p_beverages", "label": "Beverages", "items": [ { "name": "Sweet Lassi", "price": 60 }, { "name": "Salted Lassi", "price": 50 }, { "name": "Masala Chaas", "price": 40 } ] }
          ]
        },
        "chinese": {
          "label": "CHINESE",
          "categories": [
            { "id": "c_dimsum", "label": "Dim Sum", "items": [ { "name": "Veg Crystal Dumpling", "price": 220 }, { "name": "Pork Siu Mai", "price": 260 }, { "name": "Har Gao", "price": 280 } ] },
            { "id": "c_noodles", "label": "Noodles", "items": [ { "name": "Lo Mein", "price": 220 }, { "name": "Dan Dan Noodles", "price": 260 }, { "name": "Hakka Noodles", "price": 200 } ] },
            { "id": "c_wok", "label": "Wok Specials", "items": [ { "name": "Kung Pao Chicken", "price": 280 }, { "name": "Mapo Tofu", "price": 240 }, { "name": "Chilli Chicken", "price": 260 } ] }
          ]
        },
        "pizza": {
          "label": "PIZZA",
          "categories": [
            { "id": "z_classic", "label": "Classic", "items": [ { "name": "Margherita", "price": 350 }, { "name": "Marinara", "price": 330 }, { "name": "Pepperoni", "price": 450 } ] },
            { "id": "z_gourmet", "label": "Gourmet", "items": [ { "name": "Burrata Pizza", "price": 550 }, { "name": "Truffle Mushroom Pizza", "price": 520 }, { "name": "Wood Fired Chicken Pizza", "price": 480 } ] }
          ]
        },
        "snacks": {
          "label": "NASTA PANI",
          "categories": [
            { "id": "s_packaged", "label": "Packaged", "items": [ { "name": "Coke", "price": 40 }, { "name": "Thums Up", "price": 40 }, { "name": "Chips", "price": 20 }, { "name": "Kurkure", "price": 20 } ] },
            { "id": "s_hot", "label": "Hot Snacks", "items": [ { "name": "Samosa", "price": 20 }, { "name": "Veg Puff", "price": 30 }, { "name": "Burger", "price": 60 } ] }
          ]
        }
    };
    
    let ENGINE_STATE = { session_id: "auto-" + Date.now(), cuisines_detected: [], items_detected: {}, platform_strategy: { fulfillment: [] } };

    // --- 2. INPUT ENGINES ---
    let lastInputTs = 0;
    let TOUCH_ACTIVE = false;

    // GAZE
    class GazeController {
        constructor() { this.active = false; }
        start() {
            if(this.active || typeof webgazer === 'undefined') return;
            this.active = true;
            document.getElementById('eye-status').classList.add('active-pill');
            document.getElementById('gaze-dot').style.display = 'block';
            document.getElementById('btn-eye').classList.add('active');
            
            webgazer.setGazeListener((data, elapsed) => {
                if (data == null || TOUCH_ACTIVE || !GAZE_ENABLED) return;
                const dot = document.getElementById('gaze-dot');
                dot.style.left = data.x + 'px'; dot.style.top = data.y + 'px';
                if (Date.now() - lastInputTs > 1500) {
                    if (data.y < window.innerHeight * 0.2) { executeAction("SELECT"); lastInputTs = Date.now(); }
                    else if (data.x < window.innerWidth * 0.2) { executeAction("SKIP"); lastInputTs = Date.now(); }
                    else if (data.x > window.innerWidth * 0.8) { executeAction("BROWSE"); lastInputTs = Date.now(); }
                }
            }).begin();
        }
    }
    const gazeEngine = new GazeController();

    // PHYSICS + GYRO
    class PhysicsController {
        constructor(el, cbs) {
            this.el = el; this.cbs = cbs; this.active = false; this.current = {x:0, y:0}; this.target = {x:0, y:0};
            this.oSkip = el.querySelector('.overlay-skip');
            this.oBrowse = el.querySelector('.overlay-browse');
            this.oSelect = el.querySelector('.overlay-select');

            const s = e => this.start(e); const m = e => this.move(e); const e2 = () => this.end();
            el.addEventListener("mousedown",s); window.addEventListener("mousemove",m); window.addEventListener("mouseup",e2);
            el.addEventListener("touchstart",s,{passive:false}); el.addEventListener("touchmove",e=>{if(this.active)e.preventDefault();m(e)},{passive:false}); el.addEventListener("touchend",e2);
            
            if(SENSORS_ENABLED) {
                this.handleOrient = this.handleOrient.bind(this);
                if(window.DeviceOrientationEvent) window.addEventListener("deviceorientation", this.handleOrient);
                this.loop();
            }
        }
        cleanup() { window.removeEventListener("deviceorientation", this.handleOrient); }
        loop() {
            if(!SENSORS_ENABLED || TOUCH_ACTIVE) return;
            this.current.x += (this.target.x - this.current.x) * 0.08;
            this.current.y += (this.target.y - this.current.y) * 0.08;
            this.updateVisuals(this.current.x, this.current.y);
            
            // v11 MAPPING: Positive Y (Down) is SELECT
            if(Math.abs(this.current.x) > 200) this.commit(Math.sign(this.current.x)*100, 0);
            else if(Math.abs(this.current.y) > 200) this.commit(0, Math.sign(this.current.y)*100);
            else requestAnimationFrame(() => this.loop());
        }
        handleOrient(e) {
            if(this.active) return;
            let g = e.gamma; let b = e.beta - 45;
            if(Math.abs(g) > 1) this.target.x = 1000 * Math.tan(g * Math.PI / 180); else this.target.x = 0;
            if(Math.abs(b) > 1) this.target.y = 1000 * Math.tan(b * Math.PI / 180); else this.target.y = 0;
        }
        start(e) { 
            this.active=true; TOUCH_ACTIVE=true; 
            this.startPos={x:(e.touches?e.touches[0]:e).clientX, y:(e.touches?e.touches[0]:e).clientY}; 
            this.el.style.transition="none"; 
        }
        move(e) { 
            if(!this.active) return; 
            const c = (e.touches?e.touches[0]:e); 
            // v11 PHYSICS: Vertical Drag fills bar
            const dy = c.clientY - this.startPos.y;
            const dx = c.clientX - this.startPos.x;
            if(Math.abs(dy) > Math.abs(dx)) {
                let ratio = Math.min(dy/250, 1);
                if(dy>0) document.getElementById('depth-fill').style.height = (ratio*100)+'%';
            }
            this.updateVisuals(dx, dy); 
        }
        updateVisuals(dx, dy) {
            this.el.style.transform = `translate(${dx}px, ${dy}px)`;
            const opX = Math.min(Math.abs(dx)/150, 1);
            const opY = Math.min(Math.abs(dy)/150, 1);
            if(this.oSkip) this.oSkip.style.opacity = (dx < -20) ? opX : 0;
            if(this.oBrowse) this.oBrowse.style.opacity = (dx > 20) ? opX : 0;
            if(this.oSelect) this.oSelect.style.opacity = (dy > 20) ? opY : 0; // v11: Down is select
        }
        end() { 
            if(!this.active) return; this.active=false; TOUCH_ACTIVE=false;
            document.getElementById('depth-fill').style.height = '0%';
            const m = new WebKitCSSMatrix(getComputedStyle(this.el).transform);
            if(Math.hypot(m.m41, m.m42) > 80) this.commit(m.m41, m.m42);
            else { 
                this.el.style.transition="0.3s ease"; 
                this.el.style.transform="translate(0,0)"; 
                if(this.oSkip) this.oSkip.style.opacity=0;
                if(this.oBrowse) this.oBrowse.style.opacity=0;
                if(this.oSelect) this.oSelect.style.opacity=0;
            }
        }
        commit(dx, dy) {
            let dir = "RIGHT";
            const a = (Math.atan2(-dy, dx) * 180 / Math.PI + 360) % 360;
            // v11 LOGIC: 45-135 is UP (PREV), 225-315 is DOWN (SELECT)
            if(a>45 && a<135) dir = "UP"; else if(a>135 && a<225) dir = "LEFT"; else if(a>225 && a<315) dir = "DOWN"; 
            
            this.el.style.transition = "0.4s ease";
            this.el.style.transform = `translate(${dx*4}px, ${dy*4}px)`;
            this.el.style.opacity = "0";
            setTimeout(() => { this.cleanup(); this.cbs(dir); }, 300);
        }
    }

    // --- 3. APP LOGIC ---
    let container = document.getElementById('master-container');
    let slideElements = [], currentIdx = 0, activePhysics = null;

    async function boot() { renderLobby(); initVoice(); }

    function renderLobby() {
        container.innerHTML = `
        <section class="main-slide active" id="lobby">
            <div class="slide-header"><span class="header-title">SWIPE-OS v16.4</span></div>
            <div class="lobby-container">
                <h1>AAJ KYA MANGVAAYEGE!</h1>
                <div id="cuisine-grid" style="display:grid; gap:15px;">
                    <button class="cuisine-btn" onclick="toggleCuisine('punjabi', this)">PUNJABI</button>
                    <button class="cuisine-btn" onclick="toggleCuisine('chinese', this)">CHINESE</button>
                    <button class="cuisine-btn" onclick="toggleCuisine('pizza', this)">PIZZA</button>
                    <button class="cuisine-btn" onclick="toggleCuisine('snacks', this)">NASTA PANI</button>
                </div>
                <button class="hunt-btn" onclick="startHunt()">HUNT &rarr;</button>
                <div style="display:flex;gap:10px;margin-top:15px">
                    <button id="btn-gyro" class="toggle-btn" onclick="reqGyro()">ENABLE GYRO</button>
                    <button id="btn-eye" class="toggle-btn" onclick="reqGaze()">ENABLE EYES</button>
                </div>
            </div>
        </section>`;
        slideElements = [document.getElementById('lobby')];
        if(ENGINE_STATE.cuisines_detected) ENGINE_STATE.cuisines_detected.forEach(c => { const b = document.querySelector(`button[onclick*='${c}']`); if(b) b.classList.add('selected'); });
    }

    function toggleCuisine(id, btn) {
        if(ENGINE_STATE.cuisines_detected.includes(id)) { ENGINE_STATE.cuisines_detected = ENGINE_STATE.cuisines_detected.filter(c=>c!==id); btn.classList.remove('selected'); }
        else { ENGINE_STATE.cuisines_detected.push(id); btn.classList.add('selected'); }
        localStorage.setItem("ENGINE_STATE_CACHE", JSON.stringify(ENGINE_STATE));
    }

    function reqGyro() { 
        SENSORS_ENABLED = true; 
        document.getElementById('gyro-status').classList.add('active-pill'); 
        document.getElementById('btn-gyro').classList.add('active'); 
        showToast("GYRO ACTIVE"); 
    }
    function reqGaze() { 
        GAZE_ENABLED = true;
        gazeEngine.start(); 
        document.getElementById('btn-eye').classList.add('active'); 
        showToast("EYE TRACKING ON"); 
    }

    async function fetchLastOrder() {
        if (!NET_STATE.online) {
            const cached = localStorage.getItem("LAST_ORDER_CACHE");
            return cached ? JSON.parse(cached) : null;
        }
        try {
            const res = await fetch(GOOGLE_SCRIPT_URL + "?type=last_order", { cache: "no-store" });
            const json = await res.json();
            if (!json || json.error) throw "invalid";
            localStorage.setItem("LAST_ORDER_CACHE", JSON.stringify(json));
            return json;
        } catch (e) {
            const cached = localStorage.getItem("LAST_ORDER_CACHE");
            return cached ? JSON.parse(cached) : null;
        }
    }

    function startHunt() {
        if(ENGINE_STATE.cuisines_detected.length === 0) { showToast("SELECT A CUISINE"); return; }
        
        container.innerHTML = ""; slideElements = [];
        ENGINE_STATE.cuisines_detected.forEach(cId => {
            if(RAW_DATA[cId]) {
                RAW_DATA[cId].categories.forEach(cat => {
                    const s = document.createElement('section'); s.className = 'main-slide next'; s.id = cat.id; s.dataset.mode = 'options';
                    let h = `<div class="slide-header"><span class="header-title">${cat.label}</span></div><div class="carousel-viewport">`;
                    cat.items.forEach((item, i) => {
                        h += `
                        <div class="sub-slide ${i===0?'opt-active':'opt-hidden'}" data-val="${item.name}">
                            <div class="overlay-label overlay-skip">SKIP</div>
                            <div class="overlay-label overlay-browse">BROWSE</div>
                            <div class="overlay-label overlay-select">SELECT</div>
                            <div class="role-label">${cat.label}</div>
                            <h1>${item.name} ${item.price?`<span class="price">â‚¹${item.price}</span>`:""}</h1>
                            <div class="primary-question">Swipe / Tilt / Voice</div>
                            <div class="nav-hint"><span>SKIP</span><span>SELECT</span><span>BROWSE</span></div>
                        </div>`;
                    });
                    s.innerHTML = h + `</div>`; container.appendChild(s);
                });
            }
        });

        const final = document.createElement('section'); final.className = 'main-slide next'; final.id = 'final';
        final.innerHTML = `<div class="sub-slide static"><div class="verdict-container"><div class="choice-header">FINAL ORDER</div><div class="input-group" id="final-list"></div><div class="final-actions"><button class="btn btn-zomato" onclick="link('zomato')">ZOMATO</button><button class="btn btn-swiggy" onclick="link('swiggy')">SWIGGY</button><button class="btn btn-blinkit" onclick="link('blinkit')">BLINKIT</button><button class="btn btn-cloud" onclick="saveToCloud()">SAVE TO CLOUD</button><button class="btn btn-wa" onclick="goToSlide(currentIdx+1)">WHATSAPP &rarr;</button></div></div></div>`;
        container.appendChild(final);

        const biz = document.createElement('section'); biz.className = 'main-slide next'; biz.id = 'business';
        biz.innerHTML = `<div class="sub-slide static"><div class="biz-card"><span class="biz-tagline">POWERED BY KUTCH AUTOMATION</span><div class="biz-title">BUILD YOUR OWN ENGINE</div><div class="final-actions"><button class="btn btn-wa" onclick="sendWa()">CHAT WITH 916351537770</button><button class="btn" onclick="location.reload()">RESTART</button></div></div></div>`;
        container.appendChild(biz);
        
        slideElements = Array.from(document.querySelectorAll('.main-slide'));
        slideElements[0].className = "main-slide active";
        currentIdx = 0;
        if(slideElements[0].dataset.mode === 'options') attachPhysics(slideElements[0].querySelector('.sub-slide'));
    }

    function attachPhysics(el) {
        if(activePhysics) activePhysics.cleanup();
        activePhysics = new PhysicsController(el, (dir) => {
            const view = slideElements[currentIdx].querySelector('.carousel-viewport');
            const val = el.dataset.val;
            
            // v11 PHYSICS: DOWN IS SELECT
            if(dir === "DOWN") { updateCart("ADD", val); showToast("ADDED"); nextSlide(); }
            else if(dir === "LEFT") { showToast("SKIPPED"); nextSlide(); }
            else if(dir === "RIGHT") { 
                const slides = view.querySelectorAll('.sub-slide');
                let curr = 0; 
                slides.forEach((s,i) => { 
                    if(s.classList.contains('opt-active')) curr = i; 
                    s.classList.remove('opt-active'); s.classList.add('opt-hidden'); 
                    setTimeout(()=>{ s.style.transform = ''; s.style.opacity = '1'; }, 300);
                });
                const next = slides[(curr+1)%slides.length];
                next.classList.remove('opt-hidden'); next.classList.add('opt-active');
                next.style.transform = ''; next.style.opacity = '1'; 
                attachPhysics(next);
            }
            else { el.style.transform = ""; el.style.opacity = "1"; }
        });
    }

    function nextSlide() {
        if(currentIdx >= slideElements.length - 1) return;
        slideElements[currentIdx].classList.remove('active'); slideElements[currentIdx].classList.add('prev');
        currentIdx++;
        slideElements[currentIdx].classList.remove('next'); slideElements[currentIdx].classList.add('active');
        if(slideElements[currentIdx].id === 'final') renderCart();
        else if(slideElements[currentIdx].dataset.mode === 'options') attachPhysics(slideElements[currentIdx].querySelector('.sub-slide'));
    }

    function updateCart(action, payload) {
        if(action === "ADD_ITEM") {
            // Strict payload handling for voice/touch
            const name = payload.name || payload;
            const qty = payload.qty || 1;
            const currentQty = ENGINE_STATE.items_detected[name] ? ENGINE_STATE.items_detected[name].qty : 0;
            ENGINE_STATE.items_detected[name] = { qty: currentQty + qty, price: getPrice(name) };
        }
        localStorage.setItem("ENGINE_STATE_CACHE", JSON.stringify(ENGINE_STATE));
    }

    function getPrice(name) {
        for(let c in RAW_DATA) for(let cat of RAW_DATA[c].categories) for(let i of cat.items) if(i.name === name) return i.price;
        return 0;
    }

    async function renderCart() {
        const list = document.getElementById('final-list');
        if(!list) return;

        let cart = ENGINE_STATE.items_detected;
        let source = "LIVE";

        // PATCH: RECALL LAST ORDER IF EMPTY
        if (Object.keys(cart).length === 0) {
            const last = await fetchLastOrder();
            if (last && last.items) {
                cart = last.items;
                source = NET_STATE.online ? "CLOUD" : "OFFLINE CACHE";
            }
        }

        let html = '';
        let total = 0;
        
        if (!cart || Object.keys(cart).length === 0) {
            html = `<div style="text-align:center;color:#666;margin-top:20px;">No items selected.</div>`;
        } else {
            for (const [name, data] of Object.entries(cart)) {
                const price = data.price || 0;
                const qty = data.qty || 1;
                const line = price * qty;
                total += line;
                html += `<div class="input-row"><span class="input-key">${name}</span><span class="input-val">x${qty} Â· â‚¹${line}</span></div>`;
            }
            html += `<div class="input-row" style="border-top:1px solid #444;margin-top:10px"><span class="input-key">TOTAL</span><span class="input-val">â‚¹${total}</span></div>`;
            html += `<div style="text-align:center;font-size:0.7rem;color:#666;margin-top:8px">Source: ${source}</div>`;
        }
        list.innerHTML = html;
    }

    // --- ACTIONS ---
    function executeAction(act) {
        if(document.getElementById('lobby')) return;
        const s = slideElements[currentIdx];
        if(s.dataset.mode === 'options') {
            const val = s.querySelector('.opt-active').dataset.val;
            if(act === "SELECT") { updateCart("ADD_ITEM", val); showToast("ADDED"); nextSlide(); }
            if(act === "SKIP") { showToast("SKIPPED"); nextSlide(); }
            if(act === "BROWSE") {
                const view = s.querySelector('.carousel-viewport');
                const slides = view.querySelectorAll('.sub-slide');
                let curr = 0; 
                slides.forEach((s,i) => { if(s.classList.contains('opt-active')) curr = i; s.classList.remove('opt-active'); s.classList.add('opt-hidden'); setTimeout(()=>{s.style.transform='';s.style.opacity='1'},300); });
                const next = slides[(curr+1)%slides.length];
                next.classList.remove('opt-hidden'); next.classList.add('opt-active');
                next.style.transform = ''; next.style.opacity = '1';
                attachPhysics(next);
            }
        }
    }

    // --- STRICT VOICE PARSER (PATCH 1-8) ---
    const INTENT_PRIORITY = ["PLATFORM", "SYSTEM", "CART", "QUANTITY", "ACTION", "NAV", "IMPLICIT_ADD"];
    
    const VOICE_COMMANDS = {
        PLATFORM: { zomato: ["zomato"], swiggy: ["swiggy"], blinkit: ["blinkit"], whatsapp: ["whatsapp"] },
        SYSTEM: { help: ["help","commands"], copy: ["copy","clipboard"], save: ["save","cloud"] },
        CART: { add: ["add","jodo"], remove: ["remove","delete","hatao"], reset: ["clear","reset","start"], read: ["read","list"] },
        QUANTITY: { double: ["double","do","two"], half: ["half","aadha"] },
        ACTION: { select: ["select","choose","pick"], skip: ["skip"], browse: ["browse","next"] },
        NAV: { next: ["next","continue"], prev: ["back","previous"] }
    };

    function tokenize(text){ return text.toLowerCase().replace(/[^a-z0-9 ]/g,'').split(' ').filter(Boolean); }
    
    function extractNumber(text) {
        const words = text.toLowerCase().split(' ');
        const map = { "one":1, "two":2, "three":3, "four":4, "five":5, "1":1, "2":2, "3":3 };
        for(let w of words) if(map[w]) return map[w];
        return null;
    }

    function matchItem(tokens){
        for (let c in RAW_DATA){
            for (let cat of RAW_DATA[c].categories){
                for (let item of cat.items){
                    const nameTokens = tokenize(item.name);
                    // Match if at least one distinct word matches (simplified for usability)
                    if(nameTokens.some(t => tokens.includes(t))) return item.name;
                }
            }
        }
        return null;
    }

    function parseVoiceV2(text) {
        const tokens = tokenize(text);
        
        for (const group of INTENT_PRIORITY) {
            if (group === "IMPLICIT_ADD") continue; 
            const definitions = VOICE_COMMANDS[group];
            if (!definitions) continue;
            for (const [action, keywords] of Object.entries(definitions)) {
                if (keywords.some(k => tokens.includes(k))) return { group, key: action, raw: text };
            }
        }

        const qty = extractNumber(text) || 1;
        const item = matchItem(tokens);
        if (item) return { group: "IMPLICIT_ADD", item, qty };
        
        return null;
    }

    function dispatchVoice(cmd){
        if(!cmd) { speak("I didn't catch that"); return; }
        
        if (cmd.group === "PLATFORM") { copyAndRedirect(cmd.key); return; }
        
        if (cmd.group === "IMPLICIT_ADD") {
            updateCart("ADD_ITEM", { name: cmd.item, qty: cmd.qty });
            speak(`Added ${cmd.qty} ${cmd.item}`);
            showToast(`Added ${cmd.qty} ${cmd.item}`);
            return;
        }

        if(document.getElementById('lobby')) { if(cmd.key === 'next') startHunt(); return; }

        switch(cmd.group){
            case "NAV": if(cmd.key==="next") executeAction("NEXT"); break;
            case "ACTION": 
                if(cmd.key==="select") executeAction("SELECT");
                if(cmd.key==="skip") executeAction("SKIP");
                if(cmd.key==="browse") executeAction("BROWSE");
                break;
            case "SYSTEM": if(cmd.key==="save") saveToCloud(); break;
        }
    }

    // --- SMART DEEP LINKS ---
    function getCategory(name) {
        for(let c in RAW_DATA) for(let cat of RAW_DATA[c].categories) for(let i of cat.items) if(i.name === name) return cat.id;
        return "";
    }
    function link(p) {
        const allItems = Object.keys(ENGINE_STATE.items_detected);
        let validItems = [];
        if (p === 'blinkit') {
            validItems = allItems.filter(name => { const cat = getCategory(name); return cat.startsWith("s_") || cat.includes("beverage"); });
        } else {
            validItems = allItems.filter(name => { const cat = getCategory(name); return !cat.startsWith("s_packaged"); });
        }
        if (validItems.length === 0) return showToast("NO ITEMS FOR THIS APP");
        const q = encodeURIComponent(validItems.map(k => `${k} x${ENGINE_STATE.items_detected[k].qty}`).join(", "));
        const urls = { 
            zomato: `https://www.zomato.com/search?q=${q}`, 
            swiggy: `https://www.swiggy.com/search?query=${q}`, 
            blinkit: `https://blinkit.com/s/?q=${q}` 
        };
        window.open(urls[p], '_blank');
    }

    function sendWa() {
        let total = 0;
        let msg = "ðŸ“‹ *NEW ORDER*\n----------------\n";
        let i = 1;
        for(let [k,v] of Object.entries(ENGINE_STATE.items_detected)) {
            const line = v.price * v.qty;
            total += line;
            msg += `${i}. ${k} (x${v.qty}) - â‚¹${line}\n`;
            i++;
        }
        msg += "----------------\n";
        msg += `ðŸ’° *Est. Total: â‚¹${total}*\n`;
        msg += `ðŸ“ Location: Gandhidham`;
        window.open(`https://wa.me/916351537770?text=${encodeURIComponent(msg)}`, '_blank');
    }
    
    function saveToCloud() { fetch(GOOGLE_SCRIPT_URL, {method:"POST", body:JSON.stringify(ENGINE_STATE)}); showToast("SAVED"); }
    function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2000); }
    function speak(text) { window.speechSynthesis.speak(new SpeechSynthesisUtterance(text)); }

    function toggleListenMode() { 
        if(!rec) initVoice();
        const m = document.getElementById('mic-toggle');
        if(m.classList.contains('listening')) { rec.stop(); m.classList.remove('listening'); } else { rec.start(); m.classList.add('listening'); }
    }
    let rec;
    function initVoice() {
        if(!window.SpeechRecognition && !window.webkitSpeechRecognition) return;
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        rec = new SR(); rec.lang = "en-IN"; rec.continuous = true;
        rec.onresult = e => {
            const t = e.results[e.results.length-1][0].transcript;
            showToast(`"${t}"`);
            const cmd = parseVoiceV2(t);
            dispatchVoice(cmd);
        };
        rec.start();
    }

    boot();
</script>
</body>
</html>
