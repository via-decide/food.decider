<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harvey's Decision Engine | SWIPE-OS v6.6 (Voice Commander)</title>
    <style>
        /* =========================================
           CORE SYSTEM
           ========================================= */
        :root {
            --brand-orange: #ff671f;
            --brand-bg: #0a0a0a;
            --text-main: #f0f0f0;
            --accent-go: #00e676; 
            --accent-zomato: #cb202d;
            --accent-swiggy: #fc8019;
            --accent-blinkit: #f8cb46;
            --font-tech: 'Courier New', monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--brand-bg);
            color: var(--text-main);
            font-family: var(--font-ui);
            overflow: hidden;
        }

        #master-container {
            height: 100vh;
            width: 100vw;
            position: relative;
            overflow: hidden;
        }

        .main-slide {
            height: 100vh;
            width: 100vw;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            background: var(--brand-bg);
            transition: transform 0.6s cubic-bezier(0.19, 1, 0.22, 1);
            will-change: transform;
        }

        .main-slide.prev { transform: translateY(-100%); }
        .main-slide.active { transform: translateY(0); z-index: 10; }
        .main-slide.next { transform: translateY(100%); z-index: 20; }

        .slide-header {
            padding: 20px;
            border-left: 3px solid var(--brand-orange);
            height: 70px;
            flex-shrink: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            transition: opacity 0.3s;
        }
        
        .main-slide.deck-active .slide-header { opacity: 0.2; }
        .main-slide.deck-active { background: #000; }

        .header-title {
            font-family: var(--font-tech);
            font-size: 0.75rem;
            color: var(--brand-orange);
            letter-spacing: 1px;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* =========================================
           CONTENT DECK
           ========================================= */
        .carousel-viewport {
            position: relative;
            flex-grow: 1;
            width: 100%;
            touch-action: none;
        }

        .sub-slide {
            position: absolute;
            inset: 0;
            padding: 25px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transform: translateY(0) scale(1);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease;
        }

        .sub-slide.layer-1 { z-index: 30; opacity: 1; pointer-events: auto; }
        .sub-slide.layer-2 { z-index: 20; }
        .sub-slide.layer-3 { z-index: 10; }
        .sub-slide.opt-active { z-index: 30; opacity: 1; pointer-events: auto; transform: translateX(0); }
        .sub-slide.opt-hidden { z-index: 0; opacity: 0; pointer-events: none; }
        .sub-slide.static { z-index: 30; opacity: 1; pointer-events: auto; }

        h1 { font-size: 1.8rem; margin: 0 0 15px 0; line-height: 1; letter-spacing: -1px; color: var(--brand-orange); }
        .primary-question { font-size: 1.1rem; color: #fff; margin-bottom: 25px; line-height: 1.4; font-weight: 600; }
        .content-text { font-size: 0.9rem; color: #aaa; line-height: 1.6; }

        .role-label {
            font-family: var(--font-tech);
            font-size: 0.6rem;
            color: #000;
            background: var(--accent-go);
            padding: 4px 8px;
            border-radius: 4px;
            width: fit-content;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .nav-hint {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
            font-family: var(--font-tech);
            font-size: 0.7rem;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        /* =========================================
           ACTIONS & PLATFORM BUTTONS
           ========================================= */
        .final-actions {
            display: grid;
            gap: 12px;
            margin-top: 20px;
        }
        .btn {
            background: #222;
            color: #fff;
            border: 1px solid #333;
            padding: 16px;
            width: 100%;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .btn:active { transform: scale(0.98); }
        
        .btn-wa { background: #25D366; color: #000; border: none; }
        .btn-zomato { background: var(--accent-zomato); color: #fff; border: none; }
        .btn-swiggy { background: var(--accent-swiggy); color: #fff; border: none; }
        .btn-blinkit { background: var(--accent-blinkit); color: #000; border: none; }
        .btn-b2b { background: #333; border: 1px solid var(--brand-orange); color: var(--brand-orange); margin-top: 20px; }

        .status-box {
            background: #111;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
        }
        .status-val { color: var(--accent-go); font-size: 1.5rem; font-weight: bold; display: block; margin-bottom: 5px; }

        #depth-fill {
            position: fixed; right: 0; top: 0; bottom: 0; width: 4px;
            background: #333; z-index: 900;
            height: 0%; transition: height 0.05s linear, background 0.3s;
        }

        /* Toast for feedback */
        .toast-msg {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: #222; color: #00e676; padding: 12px 24px;
            border: 1px solid #00e676;
            border-radius: 30px; font-size: 0.8rem; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; z-index: 2500; font-family: var(--font-tech);
            white-space: nowrap;
        }
        .toast-msg.visible { opacity: 1; }

        /* =========================================
           LISTEN MODE UI
           ========================================= */
        #mic-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background: #111;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #444;
            z-index: 2000;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #mic-toggle svg { width: 28px; height: 28px; fill: #666; transition: fill 0.3s; }
        
        #mic-toggle.listening {
            border-color: var(--accent-go);
            background: rgba(0, 230, 118, 0.15);
            animation: pulse-mic 1.5s infinite;
        }
        #mic-toggle.listening svg { fill: var(--accent-go); }

        @keyframes pulse-mic {
            0% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(0, 230, 118, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0); }
        }

        #voice-feedback {
            position: fixed;
            bottom: 30px;
            left: 90px;
            font-family: var(--font-tech);
            font-size: 0.8rem;
            color: #fff;
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 2000;
            border-left: 2px solid var(--accent-go);
        }
        #voice-feedback.visible { opacity: 1; }

    </style>
</head>
<body>

<div id="master-container"></div>
<div id="depth-fill"></div>
<div id="toast" class="toast-msg">ACTION CONFIRMED</div>

<div id="mic-toggle" onclick="toggleListenMode()">
    <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
</div>
<div id="voice-feedback">LISTENING...</div>

<script>
    /* =========================================
       1. SMART CLIPBOARD & DEEP LINK RESOLVER
       ========================================= */
    
    // PATCH 1: Cart Text Generator
    function buildCartText(cart) {
        let items = [];
        // Map user cart keys to display text
        for (const [key, val] of Object.entries(cart)) {
            if (val) items.push(`${key.toUpperCase()}: ${val}`);
        }
        
        if (items.length === 0) return "Punjabi Food";
        
        return items.join("\n");
    }

    const PLATFORM_LINKS = {
      zomato: {
        app: q => `zomato://search?q=${encodeURIComponent(q)}`,
        web: q => `https://www.zomato.com/search?q=${encodeURIComponent(q)}`
      },
      swiggy: {
        app: q => `swiggy://search?query=${encodeURIComponent(q)}`,
        web: q => `https://www.swiggy.com/search?q=${encodeURIComponent(q)}`
      },
      blinkit: {
        app: q => `blinkit://search?query=${encodeURIComponent(q)}`,
        web: q => `https://blinkit.com/s/?q=${encodeURIComponent(q)}`
      }
    };

    // PATCH 2: Clipboard + Redirect
    async function copyAndRedirect(platform) {
        const text = buildCartText(USER_CART);
        
        try {
            await navigator.clipboard.writeText(text);
            showPasteHint(platform);
            
            setTimeout(() => {
                const links = PLATFORM_LINKS[platform];
                if (!links) return;
                
                const start = Date.now();
                window.location.href = links.app(text);
                
                setTimeout(() => {
                    if (Date.now() - start < 1500) {
                       window.location.href = links.web(text);
                    }
                }, 800);
            }, 600);

        } catch (e) {
            console.error("Clipboard failed", e);
            const links = PLATFORM_LINKS[platform];
            window.location.href = links.web(text);
        }
    }

    // PATCH 3: Paste Hint Overlay
    function showPasteHint(platform) {
        const hint = document.createElement('div');
        hint.innerHTML = `
            <div style="
              position:fixed; bottom:80px; left:50%; transform:translateX(-50%);
              background:#000; color:#fff; padding:12px 20px; border-radius:30px;
              font-size:0.8rem; z-index:9999; border:1px solid #00e676; 
              box-shadow: 0 4px 15px rgba(0,0,0,0.8); text-align:center; font-family:sans-serif;">
              ✅ CART COPIED<br>
              <span style="color:#aaa; font-size:0.75rem;">Paste in ${platform.toUpperCase()} Search</span>
            </div>
        `;
        document.body.appendChild(hint);
        setTimeout(() => hint.remove(), 3500);
    }

    /* =========================================
       2. CONFIGURATION
       ========================================= */
    const CONFIG = {
      "slides": [
        {
          "id": "slide_01_item", "type": "selector", "title": "WHAT ARE YOU CRAVING?", "hint": "Swipe left / right",
          "options": [
            { "id": "butter_chicken", "label": "Butter Chicken", "sub": "Creamy • Rich • Punjabi Classic", "tags": ["non_veg"] },
            { "id": "paneer_butter_masala", "label": "Paneer Butter Masala", "sub": "Creamy • Veg • Safe Choice", "tags": ["veg"] },
            { "id": "chole_bhature", "label": "Chole Bhature", "sub": "Heavy • Spicy • Street Style", "tags": ["veg"] }
          ]
        },
        {
          "id": "slide_02_style", "type": "decision", "title": "WHAT KIND OF MEAL?", "hint": "Swipe left / right",
          "options": [
            { "id": "comfort", "label": "Comfort Food", "sub": "Creamy • Familiar" },
            { "id": "protein", "label": "Protein Focus", "sub": "Filling • Heavy" }
          ]
        },
        {
          "id": "slide_03_people", "type": "decision", "title": "WHO ARE YOU EATING WITH?", "hint": "Swipe left / right",
          "options": [
            { "id": "solo", "label": "Just Me", "sub": "Fast • Minimal" },
            { "id": "group", "label": "Family / Friends", "sub": "Sharing Portions" }
          ]
        },
        {
          "id": "slide_04_wait", "type": "decision", "title": "HOW MUCH WAIT IS OK?", "hint": "Swipe left / right",
          "options": [
            { "id": "quick", "label": "ASAP", "sub": "Under 30 minutes" },
            { "id": "relaxed", "label": "I Can Wait", "sub": "Quality > Speed" }
          ]
        },
        {
          "id": "slide_05_llm", "type": "llm_summary", "title": "AI ANALYSIS",
          "cards": [
            { "id": "rec_a", "label": "BEST ONLINE OPTION", "sub": "Based on speed & availability", "placeholder": true },
            { "id": "rec_b", "label": "BEST LOCAL OPTION", "sub": "Direct from restaurant", "placeholder": true }
          ]
        },
        {
          "id": "slide_06_availability", "type": "status", "title": "LIVE OPTIONS",
          "display": "4 of 4 services live",
          "services": ["zomato", "swiggy", "blinkit", "local"]
        },
        // FINAL SLIDE WITH DEEP LINKS
        {
          "id": "slide_07_final", "type": "final", "title": "EXECUTE ORDER",
          "actions": [
            { "id": "zomato", "label": "Find on Zomato", "sub": "Broadest Search", "action": "zomato" },
            { "id": "swiggy", "label": "Find on Swiggy", "sub": "Fastest Delivery", "action": "swiggy" },
            { "id": "blinkit", "label": "Check Blinkit", "sub": "Ready-to-eat Only", "action": "blinkit" },
            { "id": "direct", "label": "WhatsApp Order", "sub": "Best Margin", "action": "whatsapp" },
            { "id": "b2b", "label": "Build This For My Business", "sub": "Contact Decider", "action": "b2b" }
          ]
        }
      ]
    };

    /* =========================================
       3. STATE & BUILDER
       ========================================= */
    let USER_CART = {}; 
    const container = document.getElementById('master-container');
    let slideElements = [];
    let currentIdx = 0;
    let dragRatio = 0;
    const MAX_DRAG = 300; 

    function init() {
        console.log("BOOTING SWIPE-OS v6.5...");
        
        CONFIG.slides.forEach((cfg, idx) => {
            const section = document.createElement('section');
            section.className = `main-slide ${idx === 0 ? 'active' : 'next'}`;
            section.id = cfg.id;
            
            let mode = 'static';
            if(cfg.type === 'selector' || cfg.type === 'decision') mode = 'options';
            section.dataset.mode = mode;

            let innerHTML = `<div class="slide-header"><span class="header-title">${cfg.title}</span></div>`;
            innerHTML += `<div class="carousel-viewport" data-id="${cfg.id}">`;

            if (cfg.type === 'selector' || cfg.type === 'decision') {
                const opts = cfg.options;
                opts.forEach((opt, i) => {
                    const prevText = i > 0 ? `&larr; PREV` : '';
                    const nextText = i < opts.length - 1 ? `NEXT &rarr;` : '';
                    
                    innerHTML += `
                        <div class="sub-slide ${i===0 ? 'opt-active' : 'opt-hidden'}" data-opt-idx="${i}" data-val="${opt.label}">
                            ${opt.tags ? `<div class="role-label">${opt.tags[0].toUpperCase()}</div>` : ''}
                            <h1>${opt.label}</h1>
                            <div class="primary-question">${opt.sub}</div>
                            <div class="nav-hint">
                                <span style="flex:1; text-align:left;">${prevText}</span>
                                <span style="flex:2; text-align:center; color:#fff; font-weight:bold;">&darr; PULL TO SELECT &darr;</span>
                                <span style="flex:1; text-align:right;">${nextText}</span>
                            </div>
                        </div>
                    `;
                });
            }

            else if (cfg.type === 'llm_summary') {
                innerHTML += `
                    <div class="sub-slide static">
                        <div class="role-label">AI RECOMMENDATION</div>
                        <h1>${cfg.cards[0].label}</h1>
                        <div class="content-text">${cfg.cards[0].sub}</div>
                    </div>`;
            }

            else if (cfg.type === 'status') {
                innerHTML += `
                    <div class="sub-slide static">
                        <div class="status-box">
                            <span class="status-val">${cfg.display}</span>
                            <div class="content-text">Zomato • Swiggy • Blinkit • Local</div>
                        </div>
                    </div>`;
            }

            // FINAL SLIDE WITH DEEP LINKS & LOGIC
            else if (cfg.type === 'final') {
                let btns = '';
                cfg.actions.forEach(act => {
                    let onclick = '';
                    let btnClass = 'btn';

                    // Update onclick handlers to use NEW copyAndRedirect
                    if (act.action === 'zomato') { onclick = `copyAndRedirect('zomato')`; btnClass += ' btn-zomato'; }
                    if (act.action === 'swiggy') { onclick = `copyAndRedirect('swiggy')`; btnClass += ' btn-swiggy'; }
                    if (act.action === 'blinkit') { onclick = `copyAndRedirect('blinkit')`; btnClass += ' btn-blinkit'; }
                    
                    if (act.action === 'whatsapp') {
                        onclick = `sendWhatsappTicket()`;
                        btnClass += ' btn-wa';
                    }
                    if (act.action === 'b2b') {
                        onclick = `window.open('https://wa.me/916351537770?text=BuildThisApp', '_blank')`;
                        btnClass += ' btn-b2b';
                    }
                    
                    btns += `<button class="${btnClass}" onclick="${onclick}">
                        ${act.label}
                    </button>`;
                });

                innerHTML += `
                    <div class="sub-slide static">
                        <div class="verdict-container">
                            <h1 style="text-align:center; font-size:1.5rem;">READY TO ORDER?</h1>
                            <div class="final-actions">
                                ${btns}
                            </div>
                        </div>
                    </div>`;
            }

            innerHTML += `</div>`;
            section.innerHTML = innerHTML;
            container.appendChild(section);
        });

        slideElements = Array.from(document.querySelectorAll('.main-slide'));
        attachEvents();
    }

    /* =========================================
       4. TOUCH & NAV ENGINE
       ========================================= */
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), 2000);
    }

    function sendWhatsappTicket() {
        const text = buildCartText(USER_CART);
        window.open(`https://wa.me/916351537770?text=${encodeURIComponent(text)}`, '_blank');
    }

    function goToSlide(idx) {
        if (idx < 0 || idx >= slideElements.length) return;
        
        const curr = slideElements[currentIdx];
        curr.classList.remove('active', 'deck-active');
        
        if (idx > currentIdx) { curr.classList.add('prev'); curr.classList.remove('next'); } 
        else { curr.classList.add('next'); curr.classList.remove('prev'); }

        currentIdx = idx;
        const next = slideElements[currentIdx];
        next.classList.remove('prev', 'next');
        next.classList.add('active');
        
        dragRatio = 0;
        document.getElementById('depth-fill').style.height = '0%';
    }

    function attachEvents() {
        let startX = 0, startY = 0;

        document.querySelectorAll('.carousel-viewport').forEach(view => {
            const slides = Array.from(view.querySelectorAll('.sub-slide'));
            view._currOpt = 0;
            
            let isDragging = false;
            let axis = null;

            view.addEventListener('touchstart', e => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isDragging = true;
                axis = null;
            }, {passive: true});

            view.addEventListener('touchmove', e => {
                if(!isDragging) return;
                const dx = e.touches[0].clientX - startX;
                const dy = e.touches[0].clientY - startY;

                if(!axis) axis = Math.abs(dx) > Math.abs(dy) ? 'x' : 'y';

                const parentSlide = view.closest('.main-slide');
                const mode = parentSlide.dataset.mode;

                // OPTIONS MODE: Horizontal Swipe
                if(mode === 'options') {
                    if(axis === 'x') slides.forEach(s => s.style.transform = `translateX(${dx}px)`);
                    
                    // Pull to Select
                    if(axis === 'y' && dy > 0) {
                        e.preventDefault();
                        const r = Math.min(dy/MAX_DRAG, 1);
                        document.getElementById('depth-fill').style.height = (r*100)+'%';
                    }
                    return;
                }
            }, {passive: false});

            view.addEventListener('touchend', e => {
                if(!isDragging) return;
                isDragging = false;
                
                const dx = e.changedTouches[0].clientX - startX;
                const dy = e.changedTouches[0].clientY - startY;
                const parentSlide = view.closest('.main-slide');
                const mode = parentSlide.dataset.mode;

                // Navigation: Back (Swipe Up)
                if (axis === 'y' && dy < -50) {
                    if(currentIdx > 0) goToSlide(currentIdx - 1);
                    return;
                }

                // Options Logic
                if(mode === 'options') {
                    const total = slides.length;
                    let curr = view._currOpt;

                    // Horizontal Change
                    if(axis === 'x' && Math.abs(dx) > 50) {
                        if(dx < 0 && curr < total - 1) curr++; 
                        else if(dx > 0 && curr > 0) curr--;   
                        
                        view._currOpt = curr;
                        slides.forEach((s, i) => {
                            s.style.transform = '';
                            if(i === curr) { s.classList.remove('opt-hidden'); s.classList.add('opt-active'); }
                            else { s.classList.remove('opt-active'); s.classList.add('opt-hidden'); }
                        });
                    } else {
                        slides.forEach(s => s.style.transform = '');
                    }

                    // Vertical Select
                    if(axis === 'y' && dy > 60) {
                        const val = slides[curr].dataset.val;
                        
                        // Populate Cart
                        if (parentSlide.id === 'slide_01_item') USER_CART.burger = val;
                        if (parentSlide.id === 'slide_02_style') USER_CART.style = val;
                        
                        showToast(`SELECTED: ${val}`);
                        goToSlide(currentIdx + 1);
                    }
                    document.getElementById('depth-fill').style.height = '0%';
                    return;
                }

                // Static/Status Slides: Just Next
                if(axis === 'y' && dy > 50) {
                    goToSlide(currentIdx + 1);
                }
            });
        });
    }

    /* =========================================
       VOICE COMMANDER (V1 LOGIC)
       ========================================= */
    
    // 1. INTENT SCHEMA & ALIAS MAP (PATCH 1 & 2)
    const VOICE_INTENTS = {
      ADD: ["add", "order", "chahiye", "dal do", "include", "want"],
      REMOVE: ["remove", "hatao", "delete", "nahi", "no"],
      REPEAT: ["repeat", "ek aur", "one more", "double"],
      SHOW: ["show", "cart", "order", "list"],
      FINALIZE: ["final", "done", "place", "lock", "bas"]
    };

    const ITEM_ALIASES = {
      "paneer": "Paneer Butter Masala", "pbm": "Paneer Butter Masala", "butter paneer": "Paneer Butter Masala",
      "chicken": "Butter Chicken", "bc": "Butter Chicken", "butter chicken": "Butter Chicken",
      "chole": "Chole Bhature", "bhature": "Chole Bhature",
      "crispy": "Crispy Sandwich", "burger": "Original Burger",
      "poutine": "Classic Poutine", "fries": "Frings", "rings": "Frings",
      "shake": "Chocolate Shake", "lassi": "Chocolate Shake" // Fallback alias
    };

    // 2. PARSER
    function parseVoice(cmd) {
        cmd = cmd.toLowerCase();
        let intent = "ADD"; // Default
        let item = null;

        // Detect Intent
        for (const [key, triggers] of Object.entries(VOICE_INTENTS)) {
            if (triggers.some(t => cmd.includes(t))) intent = key;
        }

        // Detect Item
        for (const [alias, realName] of Object.entries(ITEM_ALIASES)) {
            if (cmd.includes(alias)) {
                item = realName;
                break;
            }
        }

        return { intent, item };
    }

    // 3. EXECUTION ENGINE
    function executeVoice(cmd) {
        const { intent, item } = parseVoice(cmd);
        const feedback = document.getElementById('voice-feedback');

        if (intent === "SHOW") {
            speak("Your order has " + Object.values(USER_CART).join(", "));
            return;
        }

        if (intent === "FINALIZE") {
            speak("Order locked.");
            sendWhatsappTicket();
            return;
        }

        if (!item) {
            speak("I didn't catch the item name.");
            return;
        }

        if (intent === "ADD" || intent === "REPEAT") {
            // Find category for item (simple lookup)
            let cat = "misc";
            if (item.includes("Burger") || item.includes("Bhature")) cat = "burger";
            else if (item.includes("Sandwich")) cat = "chicken";
            else if (item.includes("Poutine") || item.includes("Frings")) cat = "side";
            else if (item.includes("Shake")) cat = "drink";

            if (USER_CART[cat] && intent === "REPEAT") {
                // Quantity logic would go here (v2)
                speak(`Added another ${item}`);
            } else {
                USER_CART[cat] = item;
                speak(`Added ${item}`);
                showToast(`VOICE ADD: ${item}`);
            }
        }

        if (intent === "REMOVE") {
            // Find key by value
            const key = Object.keys(USER_CART).find(k => USER_CART[k] === item);
            if (key) {
                delete USER_CART[key];
                speak(`Removed ${item}`);
                showToast(`REMOVED: ${item}`);
            } else {
                speak(`${item} is not in your cart.`);
            }
        }
    }

    // 4. TTS (PATCH 5)
    function speak(text) {
        const msg = new SpeechSynthesisUtterance(text);
        window.speechSynthesis.speak(msg);
        document.getElementById('voice-feedback').innerText = text;
    }

    // 5. LISTENER
    let recognition;
    let isListening = false;

    function toggleListenMode() {
        if (!('webkitSpeechRecognition' in window)) return alert("Use Chrome");
        
        const btn = document.getElementById('mic-toggle');
        const fb = document.getElementById('voice-feedback');

        if (isListening) {
            recognition.stop();
            isListening = false;
            btn.classList.remove('listening');
            fb.classList.remove('visible');
        } else {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-IN'; // Indian English
            recognition.continuous = false;

            recognition.onstart = () => {
                isListening = true;
                btn.classList.add('listening');
                fb.classList.add('visible');
                fb.innerText = "LISTENING...";
            };

            recognition.onend = () => {
                isListening = false;
                btn.classList.remove('listening');
                setTimeout(() => fb.classList.remove('visible'), 2000);
            };

            recognition.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                fb.innerText = `"${txt}"`;
                executeVoice(txt);
            };

            recognition.start();
        }
    }

    init(); // BOOT

</script>
</body>
</html>
